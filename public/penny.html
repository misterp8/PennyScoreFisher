<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>滿分釣手 Score Fisher - PennyABC</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        canvas {
            display: block;
        }


        @keyframes shine-sweep {
            0% {
                transform: translateX(-150%) skewX(-20deg);
            }

            50%,
            100% {
                transform: translateX(250%) skewX(-20deg);
            }
        }

        .animate-shine {
            animation: shine-sweep 3s infinite ease-in-out;
        }

        @keyframes drop-appear-slide {
            0% {
                opacity: 0;
                transform: scale(0) translateY(0);
            }

            5% {
                opacity: 0.9;
                transform: scale(1.1) translateY(0);
            }

            10% {
                transform: scale(1) translateY(0);
            }

            100% {
                opacity: 0;
                transform: scale(0.8) translateY(120vh);
            }
        }

        @keyframes drop-appear-static {
            0% {
                opacity: 0;
                transform: scale(0);
            }

            10% {
                opacity: 0.8;
                transform: scale(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(1) translateY(15px);
            }

            100% {
                opacity: 0;
                transform: scale(0.5) translateY(60px);
            }
        }

        .water-drop {
            position: absolute;
            background: radial-gradient(circle at 35% 35%, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0.9) 10%, rgba(255, 255, 255, 0.2) 50%, rgba(135, 206, 235, 0.1) 90%);
            box-shadow: inset 4px 4px 6px rgba(255, 255, 255, 0.8), inset -3px -3px 6px rgba(0, 0, 0, 0.2), 0 5px 10px rgba(0, 0, 0, 0.1);
            filter: brightness(1.2);
            z-index: 40;
            pointer-events: none;
            border-radius: 50%;
            will-change: transform, opacity, filter;
        }

        .water-drop.sliding {
            border-radius: 50% 50% 45% 45%;
        }

        #flash-overlay {
            pointer-events: none;
            background: white;
            opacity: 0;
            z-index: 70;
            mix-blend-mode: overlay;
        }


        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.4);
        }
    </style>


    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "three": "https://esm.sh/three@0.160.0",
        "three/examples/jsm/objects/Water": "https://esm.sh/three@0.160.0/examples/jsm/objects/Water.js?deps=three@0.160.0",
        "three/examples/jsm/objects/Sky": "https://esm.sh/three@0.160.0/examples/jsm/objects/Sky.js?deps=three@0.160.0"
      }
    }
    </script>
</head>

<body>
    <div id="root"></div>
    <div id="flash-overlay" class="absolute inset-0 transition-opacity duration-300"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useEffect, useRef, useState, useCallback, useMemo } from 'react';
        import ReactDOM from 'react-dom/client';
        import * as THREE from 'three';
        import { Water } from 'three/examples/jsm/objects/Water';
        import { Sky } from 'three/examples/jsm/objects/Sky';


        const GameState = {
            IDLE: 'IDLE',
            CASTING: 'CASTING',
            WAITING: 'WAITING',
            BITING: 'BITING',
            REELING: 'REELING',
            REWARD: 'REWARD'
        };

        // ==========================================
        // 此處修改釣起魚身上的分數與英文字
        // ==========================================
        const SCORE_PER_LETTER = 10; //如果有英文字每個字母算10分
        const WORD_LIST = [
            //    "A", "B", "C", "D", "E", "F", "G",
            //    "H", "I", "J", "K", "L", "M", "N",
            //    "O", "P", "Q", "R", "S", "T", "U",
            //    "V", "W", "X", "Y", "Z"
            "100", "90", "80", "70", "60", "50", "40", "30", "20", "10",
            "5", "15", "25", "35", "45", "55", "65", "75", "85", "95"
        ];

        const GAME_CONFIG = {
            maxHistory: 10,  //釣起的物品10次內不重複
            biteWindowMs: 8000,
            minWaitTimeMs: 1000,
            maxWaitTimeMs: 3000,
            fontSize: 550, //釣起魚身上的字體大小
            maxCastDistance: 210, //釣線距離數值越大越遠
        };

        // ==========================================
        // 此處為魚的模型OBJ格式
        // ==========================================
        const FISH_OBJ_DATA = `
vn 2.9875336912692254 0.0000000000000000 0.0000000000000000
v -2.5854070000000000 0.9288640000000000 1.1768500000000000
vn 1.1354943688596537 0.0000000000000000 0.0000000000000000
v -2.5854070000000000 0.6964280000000000 1.3434889999999999
vn 1.7470268832539007 0.0000000000000000 0.0000000000000000
v -2.5854070000000000 0.4607130000000000 -0.4477790000000000
vn 2.4758071960161634 0.0000000000000000 0.0000000000000000
v -2.5854070000000000 0.3854420000000000 -0.3028760000000000
vn 3.0513440968207974 0.0000000000000000 0.0000000000000000
v -2.5854070000000000 1.0542620000000000 1.0537740000000000
vn 2.2073403995563337 0.0000000000000000 0.0000000000000000
v -2.5854070000000000 0.4978680000000000 -0.4361690000000000
vn 6.2831853071795862 0.0000000000000000 0.0000000000000000
v -2.5854070000000000 0.7550800000000000 0.5737650000000000
vn 3.1415932007545253 0.0000000000000000 0.0000000000000000
v -2.5854070000000000 0.5809860000000000 0.7323360000000000
vn 3.7441542561522123 0.0000000000000000 0.0000000000000000
v -2.5854070000000000 0.8335760000000000 0.5322820000000000
vn 1.9786759778213427 0.0000000000000000 0.0000000000000000
v -2.5854070000000000 1.2121700000000000 0.8680000000000000
vn 2.6637711582141912 0.0000000000000000 0.0000000000000000
v -2.5854070000000000 1.1679700000000000 0.7784330000000000
vn 3.0392147767486852 0.0000000000000000 0.0000000000000000
v -2.5691970000000000 -0.5407070000000000 -0.4172270000000000
vn 2.0488201178087677 0.0000000000000000 0.0000000000000000
v -2.5691970000000000 -0.2407590000000000 -0.7422060000000000
vn 1.0010478111286181 0.0000000000000000 0.0000000000000000
v -2.5691970000000000 -0.4073080000000000 -0.1598520000000000
vn 2.2521812723185879 0.0000000000000000 0.0000000000000000
v -2.5691970000000000 -0.1731550000000000 -0.5661070000000000
vn 2.7359381014628474 0.0000000000000000 0.0000000000000000
v -2.5691970000000000 -0.6529460000000000 -0.7016940000000000
vn 3.5916130272973041 0.0000000000000000 0.0000000000000000
v -2.5691970000000000 -0.5000690000000000 -0.7712329999999999
vn 2.0872407025649342 0.0000000000000000 0.0000000000000000
v -2.5691970000000000 -0.6490750000000000 -0.8313480000000000
vn 2.0935001122090142 0.0000000000000000 0.0000000000000000
v -2.5691970000000000 -0.6200480000000000 -0.8467040000000000
vn 2.8583943391317339 0.0528285308980587 0.0669493538015796
v -2.4951129999999999 -0.7549190000000000 1.0667660000000001
vn 2.0724498099536302 0.0332599094889584 0.0464491957315729
v -2.4951129999999999 -0.4832170000000000 0.8722140000000000
vn 1.0185117778737496 -0.0336150948156209 -0.0024144117648166
v -2.4979640000000001 -0.4488390000000000 1.3036080000000001
vn 2.3718239372688412 -0.0855060983366983 -0.0513106570289952
v -2.4979640000000001 -0.4368620000000000 1.1368560000000001
vn 3.0505003708088245 0.0202076649501339 0.0517867313409462
v -2.5044840000000002 -0.6366830000000000 1.1684600000000001
vn 3.9434742949185182 0.0330480293768159 0.0543993586122568
v -2.5044840000000002 -0.5047130000000000 1.0554180000000000
vn 2.6294940652386307 0.0000000000000000 0.0000000000000000
v -2.4951129999999999 -0.8667049999999999 0.8959819999999999
vn 2.7197496675857651 0.0000000000000000 0.0000000000000000
v -2.4951129999999999 -0.6291600000000001 0.7681910000000000
vn 2.2933813113540991 0.0000000000000000 0.0000000000000000
v -2.4951129999999999 -0.8744680000000000 0.7810910000000000
vn 2.1541432923333108 0.0000000000000000 0.0000000000000000
v -2.4951129999999999 -0.8232320000000000 0.7293760000000000
vn 2.8606899859984787 0.0000000000000000 0.0000000000000000
v -2.4873690000000002 -0.6548800000000000 2.0737640000000002
vn 2.0732315482163863 0.0000000000000000 0.0000000000000000
v -2.4873690000000002 -0.3726710000000000 1.8716880000000000
vn 1.5309570808641686 0.0000000000000000 0.0000000000000000
v -2.4873690000000002 -0.4092640000000000 2.2850180000000000
vn 1.9532973973719818 0.0000000000000000 0.0000000000000000
v -2.4873690000000002 -0.3270200000000000 2.1813120000000001
vn 3.1415926535897953 0.0000000000000000 0.0000000000000000
v -2.4873690000000002 -0.5320720000000000 2.1793909999999999
vn 3.7762020275947039 0.0000000000000000 0.0000000000000000
v -2.4873690000000002 -0.3949990000000000 2.0619779999999999
vn 2.6294908536150814 0.0000000000000000 0.0000000000000000
v -2.4873690000000002 -0.7709890000000000 1.8963760000000001
vn 2.7197522916649901 0.0000000000000000 0.0000000000000000
v -2.4873690000000002 -0.5242580000000000 1.7636430000000001
vn 2.2933968942877163 0.0000000000000000 0.0000000000000000
v -2.4873690000000002 -0.7790520000000000 1.7770420000000000
vn 2.1541304955150431 0.0000000000000000 0.0000000000000000
v -2.4873690000000002 -0.7258360000000000 1.7233270000000001
vn 0.0220500706035541 -5.3003477698253967 0.7590585383420637
v -2.5900127160191699 -0.4421896787833764 2.6312114778386815
vn 0.0119258059599683 4.8541057152330938 1.9447050160680108
v -2.5900120251530043 0.4567627939544635 2.3420857531946098
vn -0.0167139401477264 4.6733398541424327 0.9387654943456556
v -2.5900121479793481 0.6111679588316322 1.8884153719624679
vn 0.0083305924323963 -5.2459867627699062 0.2242711744784650
v -2.5900119886182078 -0.4669497451576670 2.2795198465180198
vn 6.2539594219260577 -0.4271976545626955 0.0108882095344498
v -2.4719733004124125 -0.2215624568753689 1.5659100633596330
vn -0.0000205908756262 -4.7713459752431477 0.1962821615603020
v -2.5900119032505562 -0.5171072652188884 1.4828333905108662
vn 0.0000014282488450 -4.5580635806252072 -0.0825611676644464
v -2.5900109166751171 -0.5289235169504922 0.8780436459968610
vn -0.1331998249609088 4.4499710719101229 -0.3377252542715410
v -2.5900109999999996 0.6855030565444862 0.9384411739966914
vn 0.0095692119375135 -4.8348549938391656 -0.5613563904515201
v -2.5900110000000001 -0.4941110000000000 0.3067740000000000
vn 0.0319475363062613 4.7685244137055696 -0.9475456098606193
v -2.5900110000000001 0.5778680000000000 0.3067740000000000
vn -0.0000181630190292 -4.7872660670684386 1.8684058579879812
v -2.5900099999999999 -0.3533010000000000 -1.2563560000000000
vn 4.5135537822391463 -2.6510335068193767 0.1725612864181819
v -2.4819408587991640 -0.1540249681910945 -0.8805273599367958
vn -6.0607190981985832 0.8370652870972715 -0.4220414003067219
v -2.7081522487921998 0.1700831487967557 -0.8672179598299268
vn -0.0000150298957499 4.7282702687931666 2.0018765547963460
v -2.5900099999999999 0.4818460000000000 -1.2563560000000000
vn -6.2391118340806146 0.3859344799281942 0.0256810706212369
v -2.6802972967619749 0.3000598231772350 -1.3379591846307266
vn -4.8561622335937429 -0.7884594530412183 -2.1587450776371608
v -2.6582709258921691 0.5353618697417449 -1.7531472226430826
vn -6.2164060474063314 -0.6913400479660219 0.0743151760399814
v -2.7036672774716588 -0.0551697224660602 -0.7149326106840380
vn 6.0490641547528261 0.7259285611065266 -0.4387098197270725
v -2.4708447436639203 0.1667791748199310 -0.8658404869145794
vn 6.2475682932787331 0.4668013453974517 -0.0637345857954394
v -2.4719820346880645 0.3676705586855430 0.6817093498514709
vn 6.2270291513544800 0.5508630177612910 0.1998001561782491
v -2.4718881497940814 0.2577105279688952 2.2598864590044649
vn -6.2329366254700691 -0.5274508764783130 0.0703942727178171
v -2.7078120584754934 -0.2368237358356309 2.4262881589639402
vn 0.0000031758612348 4.2862197813854346 1.5889710199110416
v -2.5900095922787534 0.6341310268251318 -1.6038318546059689
vn -0.0000128067047060 -2.3767572861771469 -5.2690884485224343
v -2.5900089999999998 0.3599100000000000 -1.7060040000000001
vn 0.0031424933824530 2.1562749110989645 -5.2984112503238432
v -2.5900089999999998 -0.2364250000000000 -1.6962510000000000
vn -2.5344006195276183 -3.6955342926916765 1.2670327186955366
v -2.6580168803818127 -0.3843713454448188 2.8142688022727311
vn -0.1368207771350499 -3.2285617291335833 3.6020794560028091
v -2.5917622472019737 -0.2394450408438258 3.1613928928007313
vn -2.2860097374959087 1.2234402037904106 2.5925816404006841
v -2.6758600763209195 -0.0299939907624708 3.1763974431860365
vn -6.1901990653841610 0.6348475906426274 0.4684310277840730
v -2.7008439187370721 0.0947055195981340 2.6812604192887211
vn -0.0786675247157310 5.1131265790926372 2.7742618570494191
v -2.5900130194872557 0.1008760717334216 3.0036202609127876
vn 6.1911890253434327 0.6270647097551028 0.4335399445374256
v -2.4747606472726331 0.1450578786545099 2.5607606723830418
vn 4.5446420736609934 -3.2911795531578987 0.3530570446253417
v -2.5025759410869859 -0.3989907965997257 2.5779427856117052
vn -4.3265559596006540 3.2511456639000111 1.7194283376783381
v -2.6695559848610246 0.1721135409395407 2.7954375289145488
vn -4.5374389756420674 3.0454580404843510 1.3622732295982067
v -2.6779106170467268 0.3884975003901249 2.3702427979634999
vn -4.6246414703830627 -3.2687030070503300 0.2566595453549659
v -2.6777720891531356 -0.4025904580453960 2.4944981183630257
vn -6.2465267371598365 0.4726579507847208 0.0690976308337131
v -2.7080459799718248 0.3656452712727742 1.6990835189532061
vn -0.0345937436003838 4.5662333832609736 0.4206056388136782
v -2.5900110000000001 0.6877610000000000 1.3956789999999999
vn -4.7699347307426931 2.9785057320416737 0.8270452389857197
v -2.6779441638997308 0.5258542338041375 1.9650489082549369
vn 4.9382787344585246 -3.0366012840579311 0.1461854640760306
v -2.5015119340686800 -0.4148691466589979 2.0943703924380483
vn 5.0622909968625152 -2.8614862716317133 0.0476146651219023
v -2.5017147639772390 -0.4520310502248068 1.2429787634588012
vn 5.0207369060890557 2.8721138363966916 -0.3210211207689622
v -2.5020236084809380 0.6052246404018677 0.8784441010224764
vn -0.0244603697518343 -4.9662868315118587 -1.2781302927617983
v -2.5900099999999999 -0.4343050000000000 -0.0468590000000000
vn 6.2038317408695898 0.6326552286225944 -0.1903489938181958
v -2.4718992400482978 0.2090580241022316 -0.3608158361036481
vn 0.0181175672185820 5.1718879317851911 -1.4973753617711436
v -2.5900100064136118 0.4681353279538252 -0.1079724607392652
vn -4.9015520416663927 2.9605193820669986 -0.4952502360390937
v -2.6788649665716804 0.5599954726462000 0.5689196936125633
vn 4.9527952920661340 -2.9297969504306201 -0.2062065279390309
v -2.5007187286797143 -0.4357694257336553 0.4162131426639823
vn 4.6236557308170720 3.1553099209320945 -0.7789992861232310
v -2.5020432360588094 0.4568071778014013 0.0407141071063391
vn 0.1501932404991692 -5.1143692282269182 -2.0349550091757820
v -2.5900099973765789 -0.3128684186039863 -0.3548153679211726
vn -0.0000044746963460 6.0633235167068698 -0.0298703295516764
v -2.5900100948919151 0.2694051461929411 -0.6989820761028047
vn -4.6533748982241461 3.1544055341166919 -0.8135323406634669
v -2.6787567522669309 0.4262729831387379 -0.0655074742654870
vn 0.2599967740267578 -5.6973322850478514 1.4946217733829870
v -2.5900099792392046 -0.2099621909667547 -0.8993889088514372
vn 6.2201723278095713 0.5605382252341852 -0.4342367502593223
v -2.5035479999999990 0.2157409999999981 -1.0187229999999972
vn -6.2187925995599684 0.5741934996286251 -0.4454851485661188
v -2.6764720000000000 0.2157410000000000 -1.0187230000000000
vn -0.0000184674497899 5.1722756941650925 2.0575177097133546
v -2.5900099999999999 0.3730070000000000 -1.0187230000000000
vn 0.5223611907304784 -5.9397470018969472 -0.7098869345937252
v -2.5900099999999999 -0.1708046625463105 -0.6849212924605043
vn -0.0636663983605915 -4.6206835148132548 2.0522484749781604
v -2.5900094365107962 -0.5323347980852050 -1.6707997553509635
vn 6.2391334674080943 0.3880067439953725 0.0238179334393634
v -2.4997227538216058 0.3000664302014724 -1.3379748565878733
vn -4.9535634761593270 -2.8070994678729724 1.0506676459102877
v -2.6582629999999998 -0.3011040000000000 -1.2563560000000000
vn 4.9535492372232763 -2.8070914946706509 1.0506644307341055
v -2.5217559999999999 -0.3011040000000000 -1.2563560000000000
vn -6.2420221574732384 -0.5032337217177366 -0.0583915605818676
v -2.7080524465553446 -0.2229186420930511 0.1688446301929501
vn 6.2234711041693034 -0.5843236787205509 -0.1466675987254321
v -2.4719691794739420 -0.1981864398641988 -0.1404281283727229
vn -6.1920091720254664 -0.7064266895982754 -0.2357515508146170
v -2.7080920584609887 -0.1405886942539869 -0.3425348605701846
vn 6.2256862650179317 -0.4657687843148523 -0.4636776075551758
v -2.5035479999999999 -0.0987900000000000 -1.0187230000000000
vn 4.6975482530351922 0.7646192718401184 -2.3267193152784422
v -2.5141902968551721 -0.3399304255010714 -1.6994945128918022
vn -6.2397327444612296 -0.4100811537931072 0.0854364211512790
v -2.6810149999999999 -0.1445139999999977 -1.2563559999999938
vn 6.2398094128455810 -0.4147303601450363 0.0822799990750563
v -2.4990050000000004 -0.1445140000000038 -1.2563560000000005
vn 0.0000184162934527 -0.0896411541945369 -4.8255974161421875
v -2.5900089999999998 0.0666190000000000 -1.6171800000000001
vn 4.9869808504594175 -2.5962552426830090 -0.3594797463488693
v -2.4838880930217329 -0.1189785835773754 -0.6605861157145916
vn -5.9796970966506642 -0.9167109830862339 -0.3222731332588682
v -2.7117409999999991 -0.0723690000000022 -0.8595790000000026
vn -6.2531567108395532 -0.4327688568646811 0.0109308343233739
v -2.7080542256457449 -0.2177195192269874 1.7393888494607497
vn 6.2492499979532203 0.4560673661339653 0.0578488564495488
v -2.4719755949761471 0.3725905646882205 1.6233693422462090
vn 6.1991277080981160 -0.6596100487272188 0.2977672828636537
v -2.4795496588488275 -0.2580960069614365 2.6889084664604517
vn -6.2149410361962936 0.5636861301812792 0.2980741338021978
v -2.7078647144522234 0.1980142290563352 2.4199795454114938
vn 0.0000123022309564 1.0024645964532226 -1.5355873909230100
v -2.5900091338461686 0.6904556257846348 -1.8794071812701332
vn -1.7776121913887559 1.2801232852571975 -1.2207485877702280
v -2.6367868683099198 0.6815712740288503 -1.8528814387403030
vn 4.8561408842303742 -0.7884561935078196 -2.1587522802760617
v -2.5217482618709073 0.5353651449082382 -1.7531501583343985
vn 0.9488150865840128 -1.0109594423598263 -1.0497867305199753
v -2.5492265171961179 -0.5822745513526835 -1.8449254796154702
vn -0.8021673998016419 -0.8714569760470913 -1.0535942204769191
v -2.6312330094118179 -0.5810573044324637 -1.8519497492123760
vn -4.7538589855338671 0.7849183633610244 -2.2795179839172883
v -2.6658286233486819 -0.3399387040050397 -1.6994994596510591
vn 1.8957169591995187 1.1677862754030099 2.5158891088805246
v -2.5058930434885549 -0.0303407057332640 3.1900426627172198
vn 2.1442861956928225 -1.1215577345808749 2.5756859732755246
v -2.5023159649923872 -0.1878084599348901 3.1812192748164421
vn 3.5276664992893769 -3.5694169955962129 1.2631846384364196
v -2.5107179999999998 -0.3664110000000000 2.7973669999999999
vn -3.0912223683553477 -1.5398126503424814 2.5952460736116167
v -2.6779700386371852 -0.2041292639853562 3.1512094863665312
vn 4.3110559916387530 3.3155408948214218 1.7346871726660265
v -2.5107179999999998 0.1711130000000000 2.7973680000000001
vn 4.5312460673052346 3.0391236880204056 1.3854588045860259
v -2.5016379214426157 0.3839588636063430 2.3794384306407088
vn -4.9389963500814522 -3.0328815364804855 0.1419511798501945
v -2.6785125482100711 -0.4148688035788559 2.0943762191476036
vn 4.7700839759708424 2.9890372773403664 0.8277423936138193
v -2.5020799821816082 0.5258517569858068 1.9650589666659590
vn -5.0633706302344681 -2.8530241744616625 0.0465403858820236
v -2.6783070913242355 -0.4520312092646416 1.2429669016681439
vn 5.0591485299147152 2.8356469216029732 0.2007846961236974
v -2.5014820000000002 0.6121620000000000 1.3956789999999999
vn -4.9519993093178165 2.9063798588238852 0.0700464339402930
v -2.6783439213437523 0.6226162902459574 1.2801608578609707
vn -4.9501527111388235 -2.9561510004847920 -0.2034216251689317
v -2.6793030740349613 -0.4357689742207380 0.4162019860773728
vn 4.5011210043564454 -3.2068187174493259 -0.9399842496979193
v -2.5010260670420745 -0.3687171000755962 -0.0841534542823735
vn -4.6136633517568111 -3.1215060145269558 -0.8373013234540789
v -2.6785389999999998 -0.3766240000000000 -0.0468590000000000
vn -4.3073523437182857 -3.4259503913119320 -1.3105379103928885
v -2.6777724923918225 -0.2374580547633277 -0.4313881431337329
vn 4.3267104222164061 4.0414417325598597 -0.2697717639531284
v -2.4982832791143870 0.2391783408296792 -0.6849279181301988
vn -4.3197660200540184 4.0559894018937106 -0.2690966710056489
v -2.6817366843524582 0.2391783086868495 -0.6849280447174649
vn 4.6251627441992476 -3.3194044728919723 0.9122041836656856
v -2.5251630000000000 -0.2167400000000000 -1.0187230000000000
vn -4.6479709795468205 -3.2867285421226122 0.9185706691211892
v -2.6548560000000001 -0.2167400000000000 -1.0187230000000000
vn 4.6859920417675216 3.2349459241389860 0.9758963641819418
v -2.5251630000000000 0.3336910000000000 -1.0187230000000000
vn -4.6861170094352049 3.2345129711734799 0.9760475081422656
v -2.6548560000000001 0.3336910000000000 -1.0187230000000000
vn -4.4725926410718024 -3.6174752086538873 -0.0376064605253946
v -2.6833221843503696 -0.1376410649020196 -0.7227057157354823
vn 5.1166669165407095 -2.6203601654963053 1.0150863070779448
v -2.5263670000000000 -0.4021000000000000 -1.5017210000000001
vn -5.1163727123574851 -2.6214446299644498 1.0134944035430942
v -2.6536520000000001 -0.4021000000000000 -1.5017210000000001
vn 4.9835721949263094 2.7082228243717505 1.0864494703521379
v -2.5226371140852297 0.4809704311801345 -1.3783421784709431
vn -4.9835867121250326 2.7082197725398847 1.0864362295961756
v -2.6573817644671314 0.4809762712742955 -1.3783555020166049
vn -6.1705545008039957 -0.7754963971735950 0.3180980419253226
v -2.7004758828871940 -0.2580964723805406 2.6888957353261320
vn 6.2340282188873726 -0.5226310690437993 0.0674129492661287
v -2.4720736371372092 -0.2334075235188853 2.4296915248218096
vn -6.2492800039011573 0.4566576400255579 -0.0531101737602091
v -2.7080437942407753 0.3676491115080657 0.6817604051926386
vn -6.2055493272617426 0.6619032123453762 -0.1724732434947829
v -2.7081553511798933 0.2088370580804976 -0.3610799074354987
vn -6.2101188372864966 -0.5508168174156923 -0.5249059140571735
v -2.6764720000000000 -0.0987900000000031 -1.0187230000000005
vn 5.6256054840033576 -0.0397169515386132 -2.0610621951314196
v -2.5145819999999999 0.0685640000000000 -1.5393730000000001
vn -5.6255939558060417 -0.0397131059510384 -2.0610836200280307
v -2.6654369999999998 0.0685640000000000 -1.5393730000000001
vn 1.7776547226866761 1.2801337823261953 -1.2207523684634081
v -2.5432318321914247 0.6815707026546052 -1.8528808374569254
vn 2.8606854390168479 0.0000000000000000 0.0000000000000000
v -2.6810120000000000 -0.7549190000000000 1.0667660000000001
vn 2.0732382100180438 0.0000000000000000 0.0000000000000000
v -2.6810120000000000 -0.4832170000000000 0.8722140000000000
vn 1.5309599189794654 0.0000000000000000 0.0000000000000000
v -2.6810120000000000 -0.5184470000000000 1.2701540000000000
vn 1.9532978174090525 0.0000000000000000 0.0000000000000000
v -2.6810120000000000 -0.4392650000000000 1.1703090000000000
vn 3.1415926535897931 0.0000000000000000 0.0000000000000000
v -2.6810120000000000 -0.6366830000000000 1.1684600000000001
vn 3.7761988531933368 0.0000000000000000 0.0000000000000000
v -2.6810120000000000 -0.5047130000000000 1.0554180000000000
vn 2.6294940652386307 0.0000000000000000 0.0000000000000000
v -2.6810120000000000 -0.8667049999999999 0.8959819999999999
vn 2.7197496675857651 0.0000000000000000 0.0000000000000000
v -2.6810120000000000 -0.6291600000000001 0.7681910000000000
vn 2.2933813113540991 0.0000000000000000 0.0000000000000000
v -2.6810120000000000 -0.8744680000000000 0.7810910000000000
vn 2.1541432923333108 0.0000000000000000 0.0000000000000000
v -2.6810120000000000 -0.8232320000000000 0.7293760000000000
vn 2.8606899859984787 0.0000000000000000 0.0000000000000000
v -2.6935340000000001 -0.6548800000000000 2.0737640000000002
vn 2.0732315482163863 0.0000000000000000 0.0000000000000000
v -2.6935340000000001 -0.3726710000000000 1.8716880000000000
vn 1.5309570808641686 0.0000000000000000 0.0000000000000000
v -2.6935340000000001 -0.4092640000000000 2.2850180000000000
vn 1.9532973973719818 0.0000000000000000 0.0000000000000000
v -2.6935340000000001 -0.3270200000000000 2.1813120000000001
vn 3.1415926535897953 0.0000000000000000 0.0000000000000000
v -2.6935340000000001 -0.5320720000000000 2.1793909999999999
vn 3.7762020275947039 0.0000000000000000 0.0000000000000000
v -2.6935340000000001 -0.3949990000000000 2.0619779999999999
vn 2.6294908536150814 0.0000000000000000 0.0000000000000000
v -2.6935340000000001 -0.7709890000000000 1.8963760000000001
vn 2.7197522916649901 0.0000000000000000 0.0000000000000000
v -2.6935340000000001 -0.5242580000000000 1.7636430000000001
vn 2.2933968942877163 0.0000000000000000 0.0000000000000000
v -2.6935340000000001 -0.7790520000000000 1.7770420000000000
vn 2.1541304955150431 0.0000000000000000 0.0000000000000000
v -2.6935340000000001 -0.7258360000000000 1.7233270000000001
# 171 vertices, 0 vertices normals


usemtl material_0
vt 0.5141999721527100 0.7515000104904175
vt 0.4900999963283539 0.6782000064849854
vt 0.6474999785423279 0.5960000157356262
f 7/1/7 8/2/8 4/3/4
vt 0.6694999933242798 0.6276000142097473
f 7/1/7 4/3/4 3/4/3
vt 0.6678000092506409 0.6432999968528748
f 7/1/7 3/4/3 6/5/6
vt 0.5205000042915344 0.7845000028610229
f 7/1/7 6/5/6 9/6/9
vt 0.4225000143051147 0.8245999813079834
f 1/7/1 7/1/7 9/6/9
vt 0.4411999881267548 0.8773000240325928
f 1/7/1 9/6/9 5/8/5
vt 0.3971999883651733 0.7268000245094299
f 1/7/1 2/9/2 8/2/8
f 1/7/1 8/2/8 7/1/7
vt 0.4830999970436096 0.9251999855041504
f 5/8/5 9/6/9 11/10/11
vt 0.4695000052452087 0.9437999725341797
f 5/8/5 11/10/11 10/11/10
vt 0.6649000048637390 0.2063000053167343
vt 0.7142999768257141 0.3325000107288361
vt 0.6875000000000000 0.3609000146389008
f 12/12/12 13/13/13 15/14/15
vt 0.6258000135421753 0.2624000012874603
f 12/12/12 15/14/15 14/15/14
vt 0.7081000208854675 0.1590999960899353
f 13/13/13 12/12/12 16/16/16
vt 0.7186999917030334 0.2233999967575073
f 13/13/13 16/16/16 17/17/17
vt 0.7279000282287598 0.1606999933719635
f 17/17/17 16/16/16 18/18/18
vt 0.7301999926567078 0.1729000061750412
f 17/17/17 18/18/18 19/19/19
vt 0.4237999916076660 0.1659000068902969
vt 0.4410000145435333 0.2214999943971634
vt 0.4235000014305115 0.2489999979734421
f 24/20/24 25/21/25 23/22/23
vt 0.4083000123500824 0.2157000005245209
f 24/20/24 23/22/23 22/23/22
vt 0.4393000006675720 0.1162000000476837
vt 0.4688000082969666 0.2304999977350235
f 20/24/20 21/25/21 25/21/25
f 20/24/20 25/21/25 24/20/24
vt 0.4652000069618225 0.0692000016570091
f 21/25/21 20/24/20 26/26/26
vt 0.4846999943256378 0.1691000014543533
f 21/25/21 26/26/26 27/27/27
vt 0.4826999902725220 0.0658999979496002
f 27/27/27 26/26/26 28/28/28
vt 0.4905999898910522 0.0874999985098839
f 27/27/27 28/28/28 29/29/29
vt 0.2700999975204468 0.2099000066518784
vt 0.2879000008106232 0.2675999999046326
vt 0.2698000073432922 0.2962000072002411
f 34/30/34 35/31/35 33/32/33
vt 0.2540000081062317 0.2615999877452850
f 34/30/34 33/32/33 32/33/32
vt 0.2861999869346619 0.1582999974489212
vt 0.3169000148773193 0.2770000100135803
f 30/34/30 31/35/31 35/31/35
f 30/34/30 35/31/35 34/30/34
vt 0.3131000101566315 0.1093999966979027
f 31/35/31 30/34/30 36/36/36
vt 0.3332999944686890 0.2132000029087067
f 31/35/31 36/36/36 37/37/37
vt 0.3312999904155731 0.1059999987483025
f 37/37/37 36/36/36 38/38/38
vt 0.3393999934196472 0.1283999979496002
f 37/37/37 38/38/38 39/39/39
vt 0.1529999971389771 0.2904999852180481
vt 0.1761000007390976 0.2635000050067902
vt 0.1761000007390976 0.2795999944210052
f 65/40/65 64/41/64 120/42/120
vt 0.1529999971389771 0.3028999865055084
f 65/40/65 120/42/120 119/43/119
f 65/40/65 121/43/121 64/42/64
vt 0.1529999971389771 0.4882999956607819
vt 0.1529999971389771 0.4760000109672546
vt 0.1761000007390976 0.5058000087738037
f 68/44/68 118/45/118 122/46/122
vt 0.1334999948740005 0.4501000046730042
f 68/44/68 71/45/71 66/47/66
vt 0.1529999971389771 0.4388999938964844
vt 0.1529999971389771 0.3894000053405762
vt 0.1761000007390976 0.3926999866962433
f 118/48/118 119/49/119 110/50/110
vt 0.1222999989986420 0.4372000098228455
vt 0.1334999948740005 0.4587999880313873
f 118/51/118 68/52/68 66/47/66
vt 0.1761000007390976 0.4573000073432922
f 66/48/66 71/46/71 67/53/67
f 66/48/66 67/53/67 144/50/144
f 66/48/66 144/50/144 121/49/121
vt 0.1982000023126602 0.2494000047445297
vt 0.1982000023126602 0.2685000002384186
f 40/54/40 70/55/70 120/42/120
f 40/54/40 120/42/120 64/41/64
vt 0.2212000042200089 0.2644999921321869
f 40/54/40 64/55/64 73/56/73
vt 0.2467000037431717 0.5302000045776367
vt 0.2467000037431717 0.6032000184059143
vt 0.2815999984741211 0.6376000046730042
f 111/57/111 72/58/72 76/59/76
vt 0.2815999984741211 0.5565999746322632
f 111/57/111 76/59/76 74/60/74
vt 0.2815999984741211 0.4485999941825867
f 111/57/111 74/60/74 108/61/108
vt 0.1982000023126602 0.3260000050067902
f 110/62/110 120/42/120 70/55/70
vt 0.2212000042200089 0.3296999931335449
f 110/62/110 70/56/70 145/63/145
vt 0.1982000023126602 0.5557000041007996
vt 0.1761000007390976 0.5218999981880188
f 41/64/41 71/46/71 68/65/68
f 41/64/41 68/65/68 122/46/122
vt 0.1982000023126602 0.5365999937057495
f 41/64/41 122/46/122 123/66/123
vt 0.2212000042200089 0.5688999891281128
f 41/64/41 72/67/72 71/66/71
vt 0.1982000023126602 0.4792000055313110
f 67/68/67 71/66/71 72/67/72
vt 0.2212000042200089 0.5037000179290771
f 67/68/67 72/67/72 111/69/111
vt 0.2212000042200089 0.4167000055313110
vt 0.1982000023126602 0.4025999903678894
f 67/68/67 111/70/111 144/71/144
vt 0.3321999907493591 0.6998999714851379
vt 0.3321999907493591 0.6700999736785889
vt 0.3892999887466431 0.6912999749183655
f 42/72/42 125/73/125 127/74/127
vt 0.3892999887466431 0.7231000065803528
f 42/72/42 127/74/127 75/75/75
f 42/72/42 75/75/75 128/74/128
f 42/72/42 128/74/128 76/73/76
vt 0.2467000037431717 0.2381999939680099
vt 0.2212000042200089 0.2427999973297119
f 43/76/43 70/56/70 40/77/40
f 43/76/43 40/77/40 73/56/73
vt 0.2467000037431717 0.2626000046730042
vt 0.2815999984741211 0.2597000002861023
f 43/76/43 73/78/73 124/79/124
f 43/76/43 77/79/77 70/78/70
vt 0.2467000037431717 0.6276000142097473
f 41/80/41 123/58/123 125/59/125
vt 0.2815999984741211 0.6646000146865845
f 41/80/41 125/59/125 42/81/42
f 41/80/41 42/81/42 76/59/76
f 41/80/41 76/59/76 72/58/72
vt 0.2467000037431717 0.3355999886989594
f 145/82/145 70/78/70 77/79/77
vt 0.4433000087738037 0.5957000255584717
vt 0.3892999887466431 0.5958999991416931
f 146/83/146 74/84/74 128/74/128
vt 0.4433000087738037 0.6917999982833862
vt 0.4973999857902527 0.6761000156402588
f 146/83/146 128/85/128 83/86/83
vt 0.3321999907493591 0.3422999978065491
vt 0.3321999907493591 0.4614999890327454
f 44/87/44 109/88/109 145/61/145
vt 0.2815999984741211 0.3407000005245209
f 44/87/44 145/89/145 77/79/77
vt 0.3321999907493591 0.2527999877929688
vt 0.3892999887466431 0.2460999935865402
f 44/87/44 77/90/77 78/91/78
vt 0.3321999907493591 0.5806999802589417
f 74/92/74 76/73/76 128/74/128
vt 0.3321999907493591 0.2230000048875809
vt 0.2815999984741211 0.2327000051736832
f 45/93/45 77/79/77 43/94/43
f 45/93/45 43/94/43 124/79/124
f 45/93/45 124/90/124 126/91/126
f 45/93/45 78/91/78 77/90/77
vt 0.5547999739646912 0.5641999840736389
vt 0.5547999739646912 0.6486999988555908
vt 0.6086000204086304 0.6151000261306763
f 146/95/146 83/96/83 88/97/88
vt 0.6086000204086304 0.5422999858856201
f 146/95/146 88/97/88 147/98/147
vt 0.6086000204086304 0.4451999962329865
f 146/95/146 147/98/147 98/99/98
vt 0.4433000087738037 0.2113000005483627
vt 0.3892999887466431 0.2143000066280365
f 46/100/46 78/91/78 45/101/45
f 46/100/46 45/101/45 126/91/126
vt 0.4433000087738037 0.2433999925851822
vt 0.4973999857902527 0.2457000017166138
f 46/100/46 126/102/126 129/103/129
f 46/100/46 84/103/84 78/102/78
vt 0.4433000087738037 0.7239000201225281
f 47/104/47 128/74/128 75/75/75
f 47/104/47 75/75/75 127/74/127
f 47/104/47 127/74/127 79/85/79
f 47/104/47 83/86/83 128/85/128
vt 0.4433000087738037 0.3395000100135803
vt 0.4433000087738037 0.4675999879837036
vt 0.3892999887466431 0.4686999917030334
f 44/105/44 58/106/58 109/107/109
f 44/105/44 78/102/78 84/103/84
vt 0.6517999768257141 0.5996000170707703
vt 0.6517999768257141 0.5806999802589417
vt 0.6833000183105469 0.5536000132560730
f 82/108/82 85/109/85 133/110/133
vt 0.6833000183105469 0.5677000284194946
f 82/108/82 133/110/133 87/111/87
f 82/108/82 87/111/87 134/110/134
f 82/108/82 134/110/134 88/109/88
vt 0.5547999739646912 0.2258999943733215
vt 0.4973999857902527 0.2150000035762787
f 48/112/48 84/103/84 46/113/46
f 48/112/48 46/113/46 129/103/129
vt 0.5547999739646912 0.2540999948978424
vt 0.6086000204086304 0.2752999961376190
f 48/112/48 129/114/129 131/115/131
vt 0.6086000204086304 0.2511000037193298
f 48/112/48 131/115/131 80/116/80
f 48/112/48 80/116/80 130/115/130
f 48/112/48 130/115/130 84/114/84
vt 0.5547999739646912 0.6769000291824341
vt 0.4973999857902527 0.7069000005722046
f 49/117/49 83/86/83 47/118/47
f 49/117/49 47/118/47 79/86/79
f 49/117/49 79/86/79 85/96/85
vt 0.6086000204086304 0.6392999887466431
f 49/117/49 85/97/85 82/119/82
f 49/117/49 82/119/82 88/97/88
f 49/117/49 88/97/88 83/96/83
vt 0.5547999739646912 0.3386999964714050
vt 0.4973999857902527 0.3379999995231628
f 99/120/99 44/121/44 84/103/84
f 99/120/99 84/114/84 130/115/130
vt 0.7321000099182129 0.5109999775886536
vt 0.7321000099182129 0.4571999907493591
vt 0.7154999971389771 0.4566999971866608
f 52/122/52 107/123/107 56/124/56
vt 0.7321000099182129 0.5512999892234802
vt 0.7562999725341797 0.5741999745368958
f 52/122/52 134/125/134 138/126/138
vt 0.7562999725341797 0.5246000289916992
f 52/122/52 138/126/138 91/127/91
vt 0.7562999725341797 0.4584000110626221
f 52/122/52 91/127/91 148/128/148
f 52/122/52 148/128/148 107/123/107
vt 0.6517999768257141 0.3729000091552734
vt 0.6517999768257141 0.3163000047206879
vt 0.6833000183105469 0.3555000126361847
f 99/129/99 130/130/130 106/131/106
vt 0.6833000183105469 0.3978999853134155
vt 0.6833000183105469 0.4544999897480011
f 99/129/99 106/132/106 81/133/81
vt 0.6517999768257141 0.5239999890327454
vt 0.6517999768257141 0.4485000073909760
f 147/134/147 100/135/100 98/99/98
f 147/134/147 88/109/88 134/110/134
vt 0.6517999768257141 0.2973999977111816
f 86/136/86 130/115/130 80/116/80
f 86/136/86 80/116/80 131/115/131
f 86/136/86 131/115/131 132/130/132
f 86/136/86 106/131/106 130/130/130
vt 0.7925000190734863 0.2851999998092651
vt 0.7925000190734863 0.3070999979972839
vt 0.7562999725341797 0.3425999879837036
f 50/137/50 97/138/97 135/139/135
vt 0.7562999725341797 0.3260999917984009
f 50/137/50 135/139/135 89/140/89
f 50/137/50 89/140/89 136/139/136
f 50/137/50 136/139/136 96/138/96
vt 0.8298000097274780 0.2646000087261200
f 50/137/50 96/138/96 141/141/141
vt 0.8296999931335449 0.2408999949693680
f 50/137/50 141/141/141 94/142/94
f 50/137/50 94/142/94 140/141/140
f 50/137/50 140/141/140 97/138/97
vt 0.7321000099182129 0.3495000004768372
vt 0.7154999971389771 0.3714999854564667
vt 0.7154999971389771 0.3592999875545502
f 89/143/89 51/144/51 93/145/93
f 89/143/89 93/145/93 139/144/139
vt 0.7321000099182129 0.3630000054836273
f 89/143/89 139/146/139 136/139/136
f 89/143/89 135/139/135 51/146/51
vt 0.7321000099182129 0.5648000240325928
f 87/147/87 133/125/133 137/126/137
vt 0.7562999725341797 0.5906999707221985
f 87/147/87 137/126/137 92/148/92
f 87/147/87 92/148/92 138/126/138
f 87/147/87 138/126/138 134/125/134
vt 0.7321000099182129 0.4032999873161316
f 51/149/51 57/123/57 106/124/106
vt 0.7562999725341797 0.3921999931335449
f 51/149/51 135/139/135 101/150/101
f 51/149/51 101/150/101 90/128/90
f 51/149/51 90/128/90 57/123/57
vt 0.7017999887466431 0.3592999875545502
vt 0.6833000183105469 0.3413000106811523
f 93/151/93 106/131/106 86/152/86
f 93/151/93 86/152/86 132/131/132
vt 0.7017999887466431 0.3713999986648560
f 93/151/93 132/131/132 139/153/139
f 93/151/93 51/144/51 106/153/106
vt 0.7017999887466431 0.5051000118255615
vt 0.7017999887466431 0.4564999938011169
f 52/154/52 56/155/56 147/133/147
vt 0.6833000183105469 0.5110999941825867
f 52/154/52 147/156/147 134/110/134
vt 0.8582999706268311 0.2709000110626221
vt 0.8575000166893005 0.2232999950647354
f 102/157/102 140/141/140 115/158/115
vt 0.7925000190734863 0.6365000009536743
vt 0.7925000190734863 0.6146000027656555
f 53/159/53 143/160/143 138/126/138
f 53/159/53 138/126/138 92/148/92
f 53/159/53 92/148/92 137/126/137
f 53/159/53 137/126/137 142/160/142
vt 0.8300999999046326 0.6597999930381775
vt 0.8299999833106995 0.6836000084877014
f 53/159/53 142/161/142 61/162/61
f 53/159/53 61/162/61 143/161/143
vt 0.7925000190734863 0.3729999959468842
f 104/163/104 90/128/90 101/150/101
f 104/163/104 101/150/101 135/139/135
f 104/163/104 135/139/135 97/138/97
f 104/163/104 97/138/97 140/141/140
vt 0.8299999833106995 0.3357999920845032
f 104/163/104 140/141/140 102/164/102
vt 0.8355000019073486 0.4625999927520752
f 104/163/104 102/164/102 149/165/149
vt 0.7925000190734863 0.5486999750137329
vt 0.7925000190734863 0.4607999920845032
f 54/166/54 103/167/103 148/128/148
f 54/166/54 148/128/148 91/127/91
f 54/166/54 91/127/91 138/126/138
f 54/166/54 138/126/138 143/160/143
f 54/166/54 150/165/150 103/167/103
f 103/163/103 96/138/96 136/139/136
f 103/163/103 136/139/136 148/150/148
f 103/163/103 150/165/150 117/164/117
f 103/163/103 117/164/117 141/141/141
f 103/163/103 141/141/141 96/138/96
f 95/166/95 142/160/142 137/126/137
f 95/166/95 137/126/137 90/127/90
f 95/166/95 90/128/90 104/167/104
f 95/166/95 104/167/104 149/165/149
vt 0.8597000241279602 0.6492999792098999
vt 0.8302999734878540 0.5885000228881836
f 55/168/55 150/165/150 54/169/54
f 55/168/55 54/169/54 143/161/143
vt 0.8587999939918518 0.6973000168800354
f 55/168/55 143/161/143 113/170/113
vt 0.7017999887466431 0.4079000055789948
f 56/171/56 139/153/139 132/131/132
f 56/171/56 132/131/132 100/132/100
f 56/171/56 100/132/100 147/133/147
f 57/154/57 133/110/133 81/156/81
f 57/154/57 81/133/81 106/155/106
f 57/122/57 90/127/90 137/126/137
f 57/122/57 137/126/137 133/125/133
f 100/129/100 132/130/132 131/115/131
vt 0.6086000204086304 0.3481000065803528
f 100/129/100 131/115/131 98/172/98
f 81/134/81 133/110/133 85/109/85
vt 0.7154999971389771 0.4079999923706055
f 107/149/107 139/144/139 56/173/56
f 107/149/107 148/150/148 136/139/136
f 107/149/107 136/139/136 139/146/139
f 58/95/58 85/96/85 79/86/79
vt 0.4973999857902527 0.4609000086784363
vt 0.5547999739646912 0.4514000117778778
f 58/95/58 44/174/44 99/175/99
f 58/95/58 99/99/99 81/98/81
f 58/95/58 81/98/81 85/97/85
f 58/83/58 79/85/79 127/74/127
f 58/83/58 127/74/127 109/84/109
f 98/120/98 131/115/131 129/114/129
f 108/87/108 126/91/126 124/90/124
f 109/92/109 125/59/125 59/60/59
f 109/92/109 59/60/59 145/61/145
f 109/92/109 127/74/127 125/73/125
f 108/105/108 74/107/74 146/106/146
f 108/105/108 146/174/146 98/121/98
f 108/105/108 98/121/98 129/103/129
f 108/105/108 129/103/129 126/102/126
f 59/57/59 123/67/123 69/69/69
f 59/57/59 69/69/69 145/70/145
f 59/57/59 125/59/125 123/58/123
f 144/62/144 111/70/111 60/63/60
f 144/62/144 60/63/60 73/56/73
f 144/62/144 73/56/73 64/55/64
f 69/68/69 123/66/123 122/46/122
f 69/68/69 122/46/122 118/53/118
f 69/68/69 118/53/118 110/50/110
f 69/68/69 110/71/110 145/70/145
vt 0.2467000037431717 0.4329000115394592
f 60/82/60 111/176/111 108/61/108
f 60/82/60 108/89/108 124/79/124
f 60/82/60 124/79/124 73/78/73
vt 0.1529999971389771 0.3400000035762787
vt 0.1761000007390976 0.3280999958515167
f 121/177/121 144/178/144 64/42/64
f 119/177/119 120/42/120 110/178/110
vt 0.8585000038146973 0.7132999897003174
f 61/179/61 113/170/113 143/161/143
f 61/179/61 142/161/142 151/170/151
vt 0.8726999759674072 0.7132999897003174
vt 0.8769999742507935 0.7257000207901001
f 61/179/61 151/180/151 112/181/112
f 61/179/61 112/181/112 113/180/113
f 114/168/114 151/170/151 142/161/142
f 114/168/114 142/161/142 95/169/95
f 114/168/114 95/169/95 149/165/149
vt 0.8608000278472900 0.5852000117301941
vt 0.8604999780654907 0.6011999845504761
f 62/182/62 114/183/114 149/165/149
vt 0.8472999930381775 0.4618000090122223
f 62/182/62 149/165/149 105/184/105
f 62/182/62 105/184/105 150/165/150
f 62/182/62 150/165/150 55/183/55
vt 0.8744999766349792 0.6643999814987183
f 62/182/62 55/183/55 113/185/113
vt 0.8799999952316284 0.6797000169754028
f 62/182/62 113/185/113 112/186/112
f 62/182/62 112/186/112 151/185/151
f 62/182/62 151/185/151 114/183/114
vt 0.8572000265121460 0.2073999941349030
f 94/187/94 115/158/115 140/141/140
f 94/187/94 141/141/141 116/158/116
vt 0.8707000017166138 0.2030999958515167
vt 0.8748000264167786 0.1895000040531158
f 94/187/94 116/188/116 115/189/115
f 117/157/117 116/158/116 141/141/141
vt 0.8593999743461609 0.3343000113964081
vt 0.8590999841690063 0.3185000121593475
f 63/190/63 117/191/117 150/165/150
f 63/190/63 150/165/150 105/184/105
f 63/190/63 105/184/105 149/165/149
f 63/190/63 149/165/149 102/191/102
vt 0.8723000288009644 0.2511000037193298
f 63/190/63 102/191/102 115/192/115
vt 0.8773999810218811 0.2339999973773956
f 63/190/63 115/192/115 116/193/116
f 63/190/63 116/192/116 117/191/117
vt 0.1152999997138977 0.3723999857902527
vt 0.1169999986886978 0.3889999985694885
vt 0.1152999997138977 0.3889000117778778
f 65/194/65 119/195/119 118/196/118
f 65/194/65 118/196/118 66/195/66
vt 0.1222999989986420 0.3646000027656555
vt 0.1169999986886978 0.3704000115394592
f 121/197/121 65/198/65 66/195/66
f 156/20/156 157/21/157 155/22/155
f 156/20/156 155/22/155 154/23/154
f 152/24/152 153/25/153 157/21/157
f 152/24/152 157/21/157 156/20/156
f 153/25/153 152/24/152 158/26/158
f 153/25/153 158/26/158 159/27/159
f 159/27/159 158/26/158 160/28/160
f 159/27/159 160/28/160 161/29/161
f 166/30/166 167/31/167 165/32/165
f 166/30/166 165/32/165 164/33/164
f 162/34/162 163/35/163 167/31/167
f 162/34/162 167/31/167 166/30/166
f 163/35/163 162/34/162 168/36/168
f 163/35/163 168/36/168 169/37/169
f 169/37/169 168/36/168 170/38/170
f 169/37/169 170/38/170 171/39/171
`;


        const WIN_MELODY = [
            { note: 'F3', freq: 174.61, duration: 0.4 },
            { note: 'A3', freq: 220.00, duration: 0.4 },
            { note: 'C4', freq: 261.63, duration: 0.4 },
            { note: 'F4', freq: 349.23, duration: 0.4 },
            { note: 'C5', freq: 523.25, duration: 0.4 },
            { note: 'F5', freq: 698.46, duration: 3.0 }
        ];
        const NOTE_INTERVAL = 0.12;

        class AudioSynthesizer {
            constructor() {
                this.ctx = null;
                this.masterGain = null;
                this.compressor = null;
                this.reverbGain = null;
                this.oceanNode = null;
                this.oceanGain = null;
                this.noiseBuffer = null;
                this.biteIntervalID = null;
            }

            async init() {
                if (!this.ctx) {
                    const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContextClass();
                    this.masterGain = this.ctx.createGain();
                    this.masterGain.gain.value = 0.8;
                    this.compressor = this.ctx.createDynamicsCompressor();
                    this.compressor.threshold.setValueAtTime(-12, this.ctx.currentTime);
                    this.compressor.knee.setValueAtTime(30, this.ctx.currentTime);
                    this.compressor.ratio.setValueAtTime(8, this.ctx.currentTime);
                    this.compressor.attack.setValueAtTime(0.005, this.ctx.currentTime);
                    this.compressor.release.setValueAtTime(0.25, this.ctx.currentTime);
                    this.compressor.connect(this.masterGain);
                    this.masterGain.connect(this.ctx.destination);
                }
                if (!this.noiseBuffer && this.ctx) {
                    const bufferSize = this.ctx.sampleRate * 2.0;
                    const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                    const data = buffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                    this.noiseBuffer = buffer;
                }
                if (this.ctx.state === 'suspended') {
                    try { await this.ctx.resume(); } catch (e) { }
                }
            }

            playTone(freq, time, duration, type = 'triangle', vol = 0.3) {
                if (!this.ctx || !this.compressor) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = type;
                osc.frequency.value = freq;
                gain.gain.setValueAtTime(0, time);
                gain.gain.linearRampToValueAtTime(vol, time + 0.02);
                gain.gain.exponentialRampToValueAtTime(0.001, time + duration);
                osc.connect(gain);
                gain.connect(this.compressor);
                osc.start(time);
                osc.stop(time + duration + 0.1);
            }

            getWinDuration() {
                if (WIN_MELODY.length === 0) return 0;
                let maxEndTime = 0;
                WIN_MELODY.forEach((item, index) => {
                    const startTime = index * NOTE_INTERVAL;
                    const endTime = startTime + item.duration;
                    if (endTime > maxEndTime) maxEndTime = endTime;
                });
                return maxEndTime * 1000;
            }

            async playWin() {
                await this.init();
                if (!this.ctx) return;
                const now = this.ctx.currentTime;
                WIN_MELODY.forEach((item, index) => {
                    const time = now + (index * NOTE_INTERVAL);
                    this.playTone(item.freq, time, item.duration, 'square', 0.2);
                });
            }

            async startBite() {
                await this.init();
                if (this.biteIntervalID) return;
                this.stopBite();
                this.biteIntervalID = setInterval(() => {
                    if (!this.ctx) return;
                    const now = this.ctx.currentTime;
                    const carrier = this.ctx.createOscillator();
                    carrier.type = 'sawtooth';
                    const modulator = this.ctx.createOscillator();
                    const modGain = this.ctx.createGain();
                    const baseFreq = 300 + Math.random() * 150;
                    carrier.frequency.value = baseFreq;
                    modulator.frequency.setValueAtTime(baseFreq * 3, now);
                    modulator.connect(modGain);
                    modGain.gain.value = baseFreq * 1.5;
                    modGain.connect(carrier.frequency);
                    const gain = this.ctx.createGain();
                    gain.gain.setValueAtTime(0, now);
                    gain.gain.exponentialRampToValueAtTime(0.2, now + 0.01);
                    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.08);
                    carrier.connect(gain);
                    gain.connect(this.compressor);
                    modulator.start(now);
                    carrier.start(now);
                    modulator.stop(now + 0.1);
                    carrier.stop(now + 0.1);
                }, 100);
            }

            stopBite() {
                if (this.biteIntervalID) {
                    clearInterval(this.biteIntervalID);
                    this.biteIntervalID = null;
                }
            }

            async startOcean() {
                await this.init();
                if (!this.ctx || !this.compressor) return;
                if (this.oceanNode) return;
                const bufferSize = this.ctx.sampleRate * 5;
                const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) {
                    const white = Math.random() * 2 - 1;
                    let b1 = 0, b2 = 0;
                    b1 = 0.99886 * b1 + white * 0.0555179;
                    b2 = 0.99332 * b2 + white * 0.0750759;
                    data[i] = (b1 + b2 + white * 0.5368) * 0.5;
                }
                this.oceanNode = this.ctx.createBufferSource();
                this.oceanNode.buffer = buffer;
                this.oceanNode.loop = true;
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = 200;
                filter.Q.value = 1.5;
                this.oceanGain = this.ctx.createGain();
                this.oceanGain.gain.value = 0.8;
                this.oceanNode.connect(filter);
                filter.connect(this.oceanGain);
                this.oceanGain.connect(this.compressor);
                this.oceanNode.start();
                const lfo = this.ctx.createOscillator();
                lfo.frequency.value = 0.1;
                const lfoGain = this.ctx.createGain();
                lfoGain.gain.value = 100;
                lfo.connect(lfoGain);
                lfoGain.connect(filter.frequency);
                lfo.start(this.ctx.currentTime);
            }

            stopOcean() {
                if (this.oceanNode) {
                    try { this.oceanNode.stop(); } catch (e) { }
                    this.oceanNode.disconnect();
                    this.oceanNode = null;
                }
            }

            async playCast() {
                await this.init();
                if (!this.ctx) return;
                const now = this.ctx.currentTime;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, now);
                osc.frequency.exponentialRampToValueAtTime(600, now + 0.3);
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.2, now + 0.1);
                gain.gain.linearRampToValueAtTime(0, now + 0.3);
                osc.connect(gain);
                gain.connect(this.compressor);
                osc.start(now);
                osc.stop(now + 0.3);
                const noiseSource = this.ctx.createBufferSource();
                noiseSource.buffer = this.noiseBuffer;
                const noiseFilter = this.ctx.createBiquadFilter();
                noiseFilter.type = 'highpass';
                noiseFilter.frequency.setValueAtTime(800, now);
                noiseFilter.frequency.exponentialRampToValueAtTime(200, now + 0.3);
                const noiseGain = this.ctx.createGain();
                noiseGain.gain.setValueAtTime(0.3, now);
                noiseGain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                noiseSource.connect(noiseFilter);
                noiseFilter.connect(noiseGain);
                noiseGain.connect(this.compressor);
                noiseSource.start(now);
                noiseSource.stop(now + 0.3);
            }

            async playReel() {
                await this.init();
                if (!this.ctx) return;
                this.playTone(1200, this.ctx.currentTime, 0.05, 'sawtooth', 0.15);
                this.playTone(800, this.ctx.currentTime + 0.02, 0.05, 'square', 0.1);
            }

            async playClick() {
                await this.init();
                if (!this.ctx) return;
                this.playTone(1500, this.ctx.currentTime, 0.05, 'sine', 0.1);
            }

            async playWiiClick() {
                await this.init();
                if (!this.ctx || !this.compressor) return;
                const osc = this.ctx.createOscillator();
                const gain = this.ctx.createGain();
                const filter = this.ctx.createBiquadFilter();
                osc.type = 'triangle';
                filter.type = 'highpass';
                filter.frequency.value = 1200;
                osc.frequency.setValueAtTime(660, this.ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(784, this.ctx.currentTime + 0.03);
                gain.gain.setValueAtTime(0.0001, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.2, this.ctx.currentTime + 0.002);
                gain.gain.exponentialRampToValueAtTime(0.0001, this.ctx.currentTime + 0.06);
                osc.connect(filter);
                filter.connect(gain);
                gain.connect(this.compressor);
                osc.start();
                osc.stop(this.ctx.currentTime + 0.07);
            }

            async playLensHit() {
                await this.init();
                if (!this.ctx || !this.compressor || !this.noiseBuffer) return;
                const now = this.ctx.currentTime;
                const noise = this.ctx.createBufferSource();
                noise.buffer = this.noiseBuffer;
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.setValueAtTime(200, now);
                filter.Q.value = 10.0;
                filter.frequency.exponentialRampToValueAtTime(50, now + 0.1);
                const gain = this.ctx.createGain();
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(1.5, now + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(this.compressor);
                noise.start(now);
                noise.stop(now + 0.4);
            }

            async playSplash(volume = 1.0) {
                await this.init();
                if (!this.ctx || !this.compressor || !this.noiseBuffer) return;
                const now = this.ctx.currentTime;
                const noise = this.ctx.createBufferSource();
                noise.buffer = this.noiseBuffer;
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'bandpass';
                filter.Q.value = 2.5;
                filter.frequency.setValueAtTime(2000, now);
                filter.frequency.exponentialRampToValueAtTime(100, now + 0.5);
                const gain = this.ctx.createGain();
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(1.2 * volume, now + 0.01);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.6);
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(this.compressor);
                noise.start(now);
                noise.stop(now + 0.6);
            }
        }
        const audioSynth = new AudioSynthesizer();


        const ScreenDrops = () => {
            const drops = useMemo(() => {
                return Array.from({ length: 15}).map((_, i) => {
                    const isStatic = Math.random() < 0.6;
                    return {
                        left: Math.random() * 100,
                        top: Math.random() * 95,
                        size: isStatic ? 8 + Math.random() * 12 : 15 + Math.random() * 30,
                        delay: Math.random() * 0.1,
                        duration: isStatic ? 2 + Math.random() * 2 : 1.5 + Math.random() * 1.5,
                        isStatic
                    };
                });
            }, []);

            return (
                <div className="absolute inset-0 pointer-events-none overflow-hidden z-[60]">
                    {drops.map((d, i) => (
                        <div
                            key={i}
                            className={`water-drop ${!d.isStatic ? 'sliding' : ''}`}
                            style={{
                                left: `${d.left}%`, top: `${d.top}%`,
                                width: `${d.size}px`, height: `${d.size * (!d.isStatic ? 1.3 : 1)}px`,
                                animationName: d.isStatic ? 'drop-appear-static' : 'drop-appear-slide',
                                animationDuration: `${d.duration}s`, animationDelay: `${d.delay}s`,
                                animationFillMode: 'forwards',
                                animationTimingFunction: d.isStatic ? 'ease-out' : 'cubic-bezier(0.45, 0.05, 0.55, 0.95)'
                            }}
                        />
                    ))}
                </div>
            );
        };

        const Button3A = ({ onClick, text }) => (
            <button
                onClick={(e) => { e.stopPropagation(); onClick(); }}
                className="group relative px-6 py-3 md:px-20 md:py-6 lg:px-20 lg:py-8 bg-gradient-to-b from-blue-500 to-blue-700 text-white font-black text-2xl md:text-4xl tracking-[0.1em] rounded-full border-4 border-blue-400/50 shadow-[0_10px_20px_rgba(0,0,0,0.5),_inset_0_4px_4px_rgba(255,255,255,0.4),_inset_0_-4px_4px_rgba(0,0,0,0.2)] transform transition-all duration-150 ease-out hover:scale-105 hover:brightness-110 hover:shadow-[0_15px_30px_rgba(37,99,235,0.6),_inset_0_4px_4px_rgba(255,255,255,0.4)] active:scale-95 active:translate-y-1 active:shadow-[0_2px_10px_rgba(0,0,0,0.5),_inset_0_4px_8px_rgba(0,0,0,0.4)] outline-none overflow-hidden"
            >
                <span className="relative z-10 drop-shadow-md">{text}</span>
                <div className="absolute top-0 left-1/4 right-1/4 h-1/2 bg-gradient-to-b from-white/20 to-transparent rounded-full opacity-50 pointer-events-none" />
                <div className="absolute inset-0 w-1/2 h-full bg-gradient-to-r from-transparent via-white/40 to-transparent animate-shine pointer-events-none" />
            </button>
        );

        const LeaderboardModal = ({ students, onClose }) => {
            const leaderboard = useMemo(() => {
                return students
                    .map(s => {
                        const history = s.history || [];
                        let score = 0;
                        history.forEach(item => {
                            if (!isNaN(item)) {
                                score += parseInt(item);
                            } else {
                                score += SCORE_PER_LETTER;
                            }
                        });
                        return { ...s, totalScore: score };
                    })
                    .sort((a, b) => b.totalScore - a.totalScore);
            }, [students]);

            return (
                <div className="absolute inset-0 z-[80] flex items-center justify-center bg-black/20 p-4">
                    <div className="bg-gray-900/90 w-full max-w-2xl rounded-2xl border-2 border-blue-500/50 shadow-[0_0_50px_rgba(59,130,246,0.3)] overflow-hidden flex flex-col max-h-[80vh]">
                        <div className="bg-gradient-to-r from-blue-900 to-blue-800 p-6 border-b border-blue-500/30 flex justify-between items-center">
                            <h2 className="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-b from-cyan-300 to-white drop-shadow-lg tracking-widest flex items-center gap-3">
                                🏆 排行榜
                            </h2>
                            <button
                                onClick={onClose}
                                className="text-blue-200 hover:text-white bg-blue-800/50 hover:bg-red-600 rounded-full w-8 h-8 flex items-center justify-center transition-all"
                            >
                                ✕
                            </button>
                        </div>

                        <div className="p-4 overflow-y-auto flex-1 custom-scrollbar space-y-2">
                            {leaderboard.length === 0 ? (
                                <div className="text-center text-gray-400 py-8">暫無學生紀錄</div>
                            ) : (
                                leaderboard.map((student, index) => {
                                    let rankIcon = <span className="font-mono text-xl w-8 text-center text-gray-500">#{index + 1}</span>;
                                    let rowClass = "bg-gray-800/50";

                                    if (index === 0) {
                                        rankIcon = <span className="font-bold text-2xl w-8 text-center">🥇</span>;
                                        rowClass = "bg-gradient-to-r from-yellow-900/40 to-yellow-900/10 border border-yellow-600/30";
                                    } else if (index === 1) {
                                        rankIcon = <span className="font-bold text-2xl w-8 text-center">🥈</span>;
                                        rowClass = "bg-gradient-to-r from-gray-700/40 to-gray-700/10 border border-gray-400/30";
                                    } else if (index === 2) {
                                        rankIcon = <span className="font-bold text-2xl w-8 text-center">🥉</span>;
                                        rowClass = "bg-gradient-to-r from-orange-900/40 to-orange-900/10 border border-orange-700/30";
                                    }

                                    return (
                                        <div key={student.id} className={`${rowClass} rounded-lg p-4 flex items-center justify-between backdrop-blur-sm transition-transform hover:scale-[1.02]`}>
                                            <div className="flex items-center gap-4">
                                                {rankIcon}
                                                <span className="text-lg font-bold text-gray-200">{student.name}</span>
                                            </div>
                                            <div className="text-2xl font-black text-cyan-300 drop-shadow-[0_0_5px_rgba(34,211,238,0.5)]">
                                                {student.totalScore} <span className="text-sm text-gray-400 font-normal">分</span>
                                            </div>
                                        </div>
                                    );
                                })
                            )}
                        </div>

                        <div className="bg-gray-800/80 p-3 text-center text-xs text-gray-500 border-t border-gray-700">
                            同學請掌聲鼓勵!
                        </div>
                    </div>
                </div>
            );
        };

        const StudentPanel = ({
            students,
            activeStudentId,
            onGrantControl,
            maxPlays,
            setMaxPlays,
            onShowLeaderboard,
            onRequestClose,
            onForceControl,
            onToggleQR,
            isQRShown
        }) => {

            const renderHistory = (history) => {
                if (!history || history.length === 0) return <span className="text-gray-600 italic text-xs">沒有釣到任何物品</span>;
                const isAllNumbers = history.every(item => !isNaN(item));
                if (isAllNumbers) {
                    const equation = history.join(' + ');
                    const sum = history.reduce((acc, curr) => acc + parseInt(curr, 10), 0);
                    return (
                        <div className="font-mono text-yellow-300 text-sm leading-relaxed">
                            {equation} = <span className="text-white font-bold">{sum}</span>
                        </div>
                    );
                } else {
                    return (
                        <div className="text-blue-200 text-sm font-medium leading-relaxed break-words">
                            {history.join('  ')}
                        </div>
                    );
                }
            };

            return (
                <div className="w-full h-full bg-gray-900/80 border-l border-blue-500/40 flex flex-col text-white shadow-2xl transition-all duration-300">


                    <div className="mb-4 border-b border-gray-700 pb-3 pt-3 flex justify-between items-center px-4">
                        <div className="flex items-center gap-3">
                            <h2 className="text-xl font-bold text-blue-400">連線學生</h2>
                            <button
                                onClick={onShowLeaderboard}
                                className="bg-gradient-to-r from-yellow-500 to-orange-500 text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-[0_0_10px_rgba(234,179,8,0.4)] hover:scale-105 transition-transform border border-yellow-400 flex items-center gap-1"
                            >
                                <span>🏆</span> 排行榜
                            </button>
                        </div>

                        <button
                            onClick={() => onRequestClose && onRequestClose()}
                            className="text-gray-400 hover:text-white text-xl font-bold">×</button>
                    </div>


                    <div className="px-4 mb-4 flex gap-2">
                        <div className="flex items-center gap-3 bg-gray-800/50 p-2 rounded-lg border border-gray-700 flex-1">
                            <label className="text-xs text-gray-300 whitespace-nowrap">可玩次數:</label>
                            <input
                                type="number"
                                min="1"
                                max="100"
                                value={maxPlays}
                                onChange={(e) => setMaxPlays(parseInt(e.target.value) || 1)}
                                className="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-center text-sm text-yellow-400 focus:outline-none focus:border-blue-500 transition-colors"
                            />
                        </div>


                        <button
                            onClick={(e) => {
                                e.stopPropagation();
                                onToggleQR();
                            }}
                            className={`text-xs font-bold px-3 py-2 rounded-lg border shadow-lg transition-transform active:scale-95 flex items-center gap-1 whitespace-nowrap
                                ${isQRShown
                                    ? 'bg-purple-800 border-purple-500 text-white'
                                    : 'bg-purple-600 hover:bg-purple-500 border-purple-500 text-white'}`}
                            title="顯示連線 QR Code"
                        >
                            <span>📷</span> QR
                        </button>


                        <button
                            onClick={(e) => {
                                e.stopPropagation();
                                if (onForceControl) onForceControl();
                            }}
                            className="bg-red-600 hover:bg-red-500 text-white text-xs font-bold px-3 py-2 rounded-lg border border-red-500 shadow-lg transition-transform active:scale-95 flex items-center gap-1 whitespace-nowrap"
                            title="老師取回控制權"
                        >
                            <span>⚙️</span> 控制
                        </button>
                    </div>

                    <div className="flex-1 overflow-y-auto space-y-3 pr-2 pl-4 pb-4 custom-scrollbar">
                        {students.length === 0 ? (
                            <p className="text-gray-500 text-center mt-10 italic">等待學生連線中...</p>
                        ) : (
                            students.map((student) => {
                                const isActive = student.id === activeStudentId;
                                const isOnline = student.isOnline === true;
                                const currentCount = student.history ? student.history.length : 0;
                                const isLimitReached = currentCount >= maxPlays;
                                const isOfflineVisual = !isOnline;

                                return (
                                    <div
                                        key={student.id}
                                        className={`p-3 rounded-lg border transition-all flex flex-col gap-2 relative overflow-hidden ${isOfflineVisual
                                            ? 'bg-gray-800/30 border-gray-800 opacity-50 grayscale'
                                            : isActive
                                                ? 'bg-green-900/40 border-green-500 ring-1 ring-green-500/50 shadow-[0_0_15px_rgba(34,197,94,0.2)]'
                                                : isLimitReached
                                                    ? 'bg-gray-800/50 border-gray-700'
                                                    : 'bg-gray-800/80 border-gray-700 hover:border-gray-500 hover:bg-gray-800'
                                            }`}
                                    >
                                        <div className="flex justify-between items-center z-10">
                                            <span className={`font-bold truncate pr-2 ${isActive ? 'text-green-300' : 'text-gray-100'}`}>
                                                {student.name}
                                            </span>
                                            <div className="flex gap-2 items-center">
                                                {isOfflineVisual && !isActive && <span className="text-[9px] bg-gray-600 text-gray-300 px-1.5 py-0.5 rounded border border-gray-500">離線</span>}
                                                {isActive && <span className="text-[10px] bg-green-600 text-white px-2 py-0.5 rounded-full animate-pulse whitespace-nowrap">正在玩</span>}
                                                {!isActive && !isOfflineVisual && isLimitReached && <span className="text-[10px] bg-red-900/50 text-red-300 border border-red-800 px-2 py-0.5 rounded-full whitespace-nowrap">次數已滿</span>}
                                            </div>
                                        </div>

                                        <div className="bg-black/20 rounded p-2 h-16 overflow-y-auto z-10 border border-white/5 custom-scrollbar">
                                            {renderHistory(student.history)}
                                        </div>

                                        <div className="flex justify-between items-center z-10 mt-1">
                                            <span className="text-xs text-gray-400 font-mono">{currentCount} / {maxPlays}</span>
                                            {student.id !== activeStudentId && isOnline && (
                                                <button
                                                    onClick={() => !isLimitReached && onGrantControl(student.id)}
                                                    disabled={isLimitReached}
                                                    className={`px-3 py-1 text-xs font-semibold rounded transition-all duration-200 shadow-lg transform active:scale-95 ${isLimitReached
                                                        ? 'bg-gray-700 text-gray-500 cursor-not-allowed'
                                                        : 'bg-blue-600 hover:bg-blue-500 text-white hover:shadow-[0_0_10px_rgba(37,99,235,0.5)]'
                                                        }`}
                                                >
                                                    選擇學生
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                );
                            })
                        )}
                    </div>

                    <div className="text-[10px] text-gray-600 pt-2 border-t border-gray-800 text-center px-4 pb-2">
                        PennyABC
                    </div>
                </div>
            );
        };


        const UIOverlay = ({ gameState, onReset, hasStarted, onStart, showRewardButton = false, showScreenSplashes }) => {
            if (!hasStarted) {
                return (
                    <div className="absolute inset-0 z-40 flex flex-col items-center justify-center bg-black/60 select-none transition-opacity duration-1000">
                        <div className="mb-20 text-center animate-fade-in-up">
                            <h1 className="text-7xl md:text-9xl font-black text-transparent bg-clip-text bg-gradient-to-b from-cyan-300 to-blue-600 drop-shadow-[0_0_40px_rgba(6,182,212,0.6)] tracking-tighter filter">
                                Score Fisher
                            </h1>
                            <div className="h-2 w-120 bg-cyan-400 mx-auto mt-4 mb-6 rounded-full shadow-[0_0_15px#22d3ee]"></div>
                            <p className="text-xl md:text-3xl text-cyan-200 font-bold tracking-[0.4em] drop-shadow-[0_0_10px_rgba(34,211,238,0.5)]">
                              PennyABC
                            </p>
                        </div>
                        <div className="pointer-events-auto animate-pulse-slow">
                            <Button3A onClick={onStart} text="開始釣魚" />
                        </div>
                    </div>
                );
            }

            return (
                <div className="absolute inset-0 pointer-events-none flex flex-col items-center justify-between p-6 z-30 select-none">
                    {showScreenSplashes && <ScreenDrops />}
                    <div className="flex-1 flex items-end justify-center pointer-events-auto pb-16 z-50">
                        {gameState === GameState.REWARD && showRewardButton && (
                            <div className="animate-fade-in flex flex-col items-center gap-8 transition-opacity duration-500 ease-in">
                                <Button3A onClick={onReset} text="再玩一次" />
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const WATER_NORMALS_URL = 'https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/water/Water_1_M_Normal.jpg';
        const SCENE_SETTINGS = {
            waterColor: 0x0077be,
            sunColor: 0xbbbbff,
            ambientLightColor: 0xffffff,
            sky: {
                turbidity: 0.5,
                rayleigh: 1,
                mieCoefficient: 0.005,
                mieDirectionalG: 1.0,
                elevation: 20,
                azimuth: 5
            },
            ambientLightIntensity: 1.0,
            dirLightIntensity: 2.0
        };
        const CAMERA_CONFIG = {
            position: { x: 0, y: 35, z: 90 },
            lookAt: { x: 0, y: 0, z: 0 }
        };
        const ROD_CONFIG = {
            position: { x: 5, y: 20, z: 90 },
            rotation: { x: 0, y: 0, z: 0 }
        };
        const ORIG_EYE_L = new THREE.Vector3(1.0, 0.3, 0.21);
        const ORIG_EYE_R = new THREE.Vector3(1.0, 0.3, -0.21);
        const ORIG_LABEL_L = new THREE.Vector3(0, 0.1, 0.7);
        const ORIG_LABEL_R = new THREE.Vector3(0, 0.1, -0.7);
        const FISH_VARIATION_COUNT = 5;

        const parseCustomOBJ = (data) => {
            const vertices = [];
            const normals = [];
            const uvs = [];
            const fPositions = [];
            const fNormals = [];
            const fUvs = [];
            const lines = data.split('\n');
            for (let line of lines) {
                line = line.trim();
                if (line.length === 0 || line.startsWith('#')) continue;
                const parts = line.split(/\s+/);
                const type = parts[0];
                if (type === 'v') {
                    vertices.push(parseFloat(parts[1]), parseFloat(parts[2]), parseFloat(parts[3]));
                } else if (type === 'vn') {
                    normals.push(parseFloat(parts[1]), parseFloat(parts[2]), parseFloat(parts[3]));
                } else if (type === 'vt') {
                    uvs.push(parseFloat(parts[1]), parseFloat(parts[2]));
                } else if (type === 'f') {
                    const faceVertices = parts.slice(1);
                    for (let i = 1; i < faceVertices.length - 1; i++) {
                        const indices = [0, i, i + 1];
                        for (const idx of indices) {
                            const vertexStr = faceVertices[idx];
                            const [vIdx, vtIdx, vnIdx] = vertexStr.split('/').map(s => s ? parseInt(s) : undefined);
                            if (vIdx !== undefined) {
                                const vIndex = (vIdx > 0 ? vIdx - 1 : vertices.length / 3 + vIdx) * 3;
                                fPositions.push(vertices[vIndex], vertices[vIndex + 1], vertices[vIndex + 2]);
                            }
                            if (vtIdx !== undefined) {
                                const vtIndex = (vtIdx > 0 ? vtIdx - 1 : uvs.length / 2 + vtIdx) * 2;
                                fUvs.push(uvs[vtIndex], uvs[vtIndex + 1]);
                            } else {
                                fUvs.push(0, 0);
                            }
                            if (vnIdx !== undefined) {
                                const vnIndex = (vnIdx > 0 ? vnIdx - 1 : normals.length / 3 + vnIdx) * 3;
                                fNormals.push(normals[vnIndex], normals[vnIndex + 1], normals[vnIndex + 2]);
                            } else {
                                fNormals.push(0, 1, 0);
                            }
                        }
                    }
                }
            }
            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(fPositions, 3));
            if (fNormals.length > 0) geometry.setAttribute('normal', new THREE.Float32BufferAttribute(fNormals, 3));
            if (fUvs.length > 0) geometry.setAttribute('uv', new THREE.Float32BufferAttribute(fUvs, 2));
            geometry.computeBoundingSphere();
            return geometry;
        };

        const FishingGame = () => {
            const containerRef = useRef(null);

            const [gameState, setGameState] = useState(GameState.IDLE);
            const [hasStarted, setHasStarted] = useState(false);
            const [showRewardButton, setShowRewardButton] = useState(false);
            const [showScreenSplashes, setShowScreenSplashes] = useState(false);
            const [showSidebar, setShowSidebar] = useState(false);
            const [showLeaderboard, setShowLeaderboard] = useState(false);


            const [showQR, setShowQR] = useState(false);

            const [students, setStudents] = useState([]);
            const [activeStudentId, setActiveStudentId] = useState(null);
            const [maxPlays, setMaxPlays] = useState(3);

            const wsRef = useRef(null);
            const activeControlRef = useRef(null);
            const remoteMoveDirRef = useRef({ x: 0, y: 0 });

            const stateRef = useRef(GameState.IDLE);
            const audioEnabledRef = useRef(false);
            const triggerGameActionRef = useRef(null);
            const cameraShakeRef = useRef({ intensity: 0, decay: 0 });
            const sceneRef = useRef(null);
            const cameraRef = useRef(null);
            const rendererRef = useRef(null);
            const waterRef = useRef(null);
            const raycasterRef = useRef(new THREE.Raycaster());
            const mouseRef = useRef(new THREE.Vector2());
            const reqIdRef = useRef(0);

            const dummyLookTarget = useRef(new THREE.Object3D());
            const hasPlayedWinSound = useRef(false);
            const hasPlayedLensSound = useRef(false);
            const rodTipSubmergedRef = useRef(false);

            const bubblesRef = useRef([]);
            const ripplesRef = useRef([]);
            const splashParticlesRef = useRef([]);

            const bobberRef = useRef(null);
            const arrowRef = useRef(null);

            const fishVariationsRef = useRef([]);
            const activeFishIndexRef = useRef(0);
            const recentHuesRef = useRef([]);

            const lineRef = useRef(null);
            const rodPivotRef = useRef(null);
            const rodTipRef = useRef(null);

            const targetPosition = useRef(new THREE.Vector3());
            const castStartTime = useRef(0);
            const castDuration = 1000;
            const biteTimeRef = useRef(0);
            const catchHistory = useRef([]);

            const forceResetGame = useCallback(() => {
                if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {
                    wsRef.current.send(JSON.stringify({ type: 'REVOKE_CONTROL' }));
                }
                setActiveStudentId(null);
                activeControlRef.current = null;
                remoteMoveDirRef.current = { x: 0, y: 0 };
                mouseRef.current.set(0, 0);

                stateRef.current = GameState.IDLE;
                setGameState(GameState.IDLE);

                setShowRewardButton(false);
                setShowScreenSplashes(false);
                hasPlayedWinSound.current = false;
                hasPlayedLensSound.current = false;
                stopBiteSound();

                fishVariationsRef.current.forEach(g => g.visible = false);
                if (bobberRef.current) bobberRef.current.visible = false;
                if (lineRef.current) lineRef.current.visible = false;

                if (rodPivotRef.current) {
                    rodPivotRef.current.position.set(ROD_CONFIG.position.x, ROD_CONFIG.position.y, ROD_CONFIG.position.z);
                    rodPivotRef.current.rotation.set(ROD_CONFIG.rotation.x, ROD_CONFIG.rotation.y, ROD_CONFIG.rotation.z);
                }
            }, []);

            useEffect(() => {
                try {
                    wsRef.current = new WebSocket('wss://pennyscorefisher.onrender.com');

                    wsRef.current.onopen = () => {
                        console.log('Teacher Connected to WS');
                        wsRef.current.send(JSON.stringify({ type: 'JOIN_TEACHER' }));
                    };

                    wsRef.current.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);

                            if (data.type === 'STUDENT_LIST') {
                                setStudents(prevStudents => {
                                    const serverMap = new Map(data.list.map(s => [s.id, s]));
                                    const updatedList = [];
                                    data.list.forEach(serverStudent => {
                                        const localStudent = prevStudents.find(ls => ls.id === serverStudent.id);
                                        updatedList.push({
                                            ...serverStudent,
                                            isOnline: true,
                                            history: (localStudent && localStudent.history) || serverStudent.history || []
                                        });
                                    });
                                    prevStudents.forEach(localStudent => {
                                        if (!serverMap.has(localStudent.id)) {
                                            if (localStudent.history && localStudent.history.length > 0) {
                                                updatedList.push({
                                                    ...localStudent,
                                                    isOnline: false
                                                });
                                            }
                                        }
                                    });
                                    return updatedList;
                                });
                            } else if (data.type === 'GAME_ACTION') {
                                handleRemoteAction(data.action, data.dir);
                            }
                        } catch (e) {
                            console.error("WS Data parse error", e);
                        }
                    };
                } catch (e) { console.warn("WS connection failed"); }
                return () => { if (wsRef.current) wsRef.current.close(); };
            }, []);

            useEffect(() => {
                if (!activeStudentId || !wsRef.current || wsRef.current.readyState !== WebSocket.OPEN) return;
                const shouldVibrate = gameState === GameState.BITING;
                try {
                    wsRef.current.send(JSON.stringify({
                        type: 'GAME_STATE_UPDATE',
                        state: gameState,
                        vibrate: shouldVibrate,
                        targetId: activeStudentId
                    }));
                } catch (e) { console.error("WS Error sending state:", e); }
            }, [gameState, activeStudentId]);

            const handleRemoteAction = useCallback((action, dir) => {
                if (!activeControlRef.current) return;
                if (action === 'MOVE_START') {
                    if (dir === 'UP') remoteMoveDirRef.current.y = 1;
                    if (dir === 'DOWN') remoteMoveDirRef.current.y = -1;
                    if (dir === 'LEFT') remoteMoveDirRef.current.x = -1;
                    if (dir === 'RIGHT') remoteMoveDirRef.current.x = 1;
                } else if (action === 'MOVE_END') {
                    if (dir === 'UP' || dir === 'DOWN') remoteMoveDirRef.current.y = 0;
                    if (dir === 'LEFT' || dir === 'RIGHT') remoteMoveDirRef.current.x = 0;
                } else if (action === 'INTERACT') {
                    if (triggerGameActionRef.current) triggerGameActionRef.current();
                }
            }, []);

            const updateStudentHistory = useCallback((studentId, content) => {
                setStudents(prevStudents => {
                    return prevStudents.map(student => {
                        if (student.id === studentId) {
                            return {
                                ...student,
                                history: [...(student.history || []), content]
                            };
                        }
                        return student;
                    });
                });
            }, []);

            const grantControl = useCallback((id) => {
                const student = students.find(s => s.id === id);
                if (student && student.history && student.history.length >= maxPlays) return;

                if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {
                    remoteMoveDirRef.current = { x: 0, y: 0 };
                    mouseRef.current.set(0, 0);
                    wsRef.current.send(JSON.stringify({ type: 'GRANT_CONTROL', targetId: id }));
                    setActiveStudentId(id);
                    activeControlRef.current = id;
                    wsRef.current.send(JSON.stringify({
                        type: 'GAME_STATE_UPDATE',
                        state: gameState,
                        vibrate: false,
                        targetId: id
                    }));
                } else {
                    setActiveStudentId(id);
                    activeControlRef.current = id;
                }
            }, [gameState, students, maxPlays]);

            const triggerGameAction = useCallback(() => {
                if (!hasStarted) return;
                if (!audioEnabledRef.current) { audioEnabledRef.current = true; audioSynth.init(); }
                const currentState = stateRef.current;
                if (currentState === GameState.IDLE) {
                    if (rodTipRef.current) {
                        const worldRodTip = new THREE.Vector3();
                        rodTipRef.current.getWorldPosition(worldRodTip);
                        if (worldRodTip.y < 0) { playSound('click'); return; }
                    }
                    if (waterRef.current && raycasterRef.current && cameraRef.current) {
                        raycasterRef.current.setFromCamera(mouseRef.current, cameraRef.current);
                        const intersects = raycasterRef.current.intersectObject(waterRef.current);

                        let targetPoint;

                        if (intersects.length > 0) {
                            targetPoint = intersects[0].point;
                            if (targetPoint.z > 80) {
                                const dir = targetPoint.clone().sub(cameraRef.current.position);
                                dir.y = 0;
                                dir.normalize();
                                targetPoint = cameraRef.current.position.clone().add(dir.multiplyScalar(GAME_CONFIG.maxCastDistance));
                                targetPoint.y = 0;
                            }
                        } else {
                            const dir = raycasterRef.current.ray.direction.clone();
                            dir.y = 0;
                            dir.normalize();
                            targetPoint = cameraRef.current.position.clone().add(dir.multiplyScalar(GAME_CONFIG.maxCastDistance));
                            targetPoint.y = 0;
                        }
                        const dist = Math.sqrt(targetPoint.x * targetPoint.x + targetPoint.z * targetPoint.z);
                        let target = targetPoint.clone();
                        if (dist > GAME_CONFIG.maxCastDistance) {
                            const ratio = GAME_CONFIG.maxCastDistance / dist;
                            target.x *= ratio;
                            target.z *= ratio;
                        }
                        targetPosition.current.copy(target);
                        castStartTime.current = performance.now();
                        stateRef.current = GameState.CASTING;
                        setGameState(GameState.CASTING);
                        if (bobberRef.current) bobberRef.current.visible = true;
                        if (lineRef.current) lineRef.current.visible = true;
                        playSound('cast');
                    }
                } else if (currentState === GameState.BITING) {
                    stopBiteSound();
                    stateRef.current = GameState.REELING;
                    setGameState(GameState.REELING);
                    playSound('reel');
                    playSound('wiiClick');
                    const getNextContent = () => {
                        const history = catchHistory.current;
                        const available = WORD_LIST.filter(w => !history.includes(w));
                        const pool = available.length > 0 ? available : WORD_LIST;
                        const randomWord = pool[Math.floor(Math.random() * pool.length)];
                        const newHistory = [randomWord, ...history].slice(0, GAME_CONFIG.maxHistory);
                        catchHistory.current = newHistory;
                        return randomWord;
                    };
                    const content = getNextContent();
                    if (activeStudentId) updateStudentHistory(activeStudentId, content);

                    const getRandomDeepColor = () => {
                        const deepColors = ["#D50000", "#C51162", "#AA00FF", "#6200EA", "#304FFE", "#2962FF", "#0091EA", "#00C853", "#FF6D00", "#DD2C00", "#8B0000", "#00008B", "#4B0082", "#C71585", "#004D40", "#880E4F", "#4A148C"];
                        return deepColors[Math.floor(Math.random() * deepColors.length)];
                    };
                    const randIndex = Math.floor(Math.random() * FISH_VARIATION_COUNT);
                    activeFishIndexRef.current = randIndex;
                    fishVariationsRef.current.forEach((g, i) => { g.visible = (i === randIndex); });
                    const activeFish = fishVariationsRef.current[randIndex];
                    if (activeFish) {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const fontSize = GAME_CONFIG.fontSize;
                        if (ctx) {
                            canvas.width = 1024;
                            canvas.height = 512;
                            ctx.clearRect(0, 0, 1024, 512);
                            ctx.textAlign = "center";
                            ctx.textBaseline = "middle";
                            ctx.font = `bold ${fontSize}px Arial`;
                            ctx.shadowColor = "rgba(0,0,0,0.5)";
                            ctx.shadowBlur = 10;
                            ctx.strokeStyle = getRandomDeepColor();
                            ctx.lineWidth = 20;
                            ctx.strokeText(content, 512, 256);
                            ctx.fillStyle = "white";
                            ctx.fillText(content, 512, 256);
                        }
                        const tex = new THREE.CanvasTexture(canvas);
                        ['label_right'].forEach(name => {
                            const label = activeFish.getObjectByName(name);
                            if (label) { label.material.map = tex; label.material.needsUpdate = true; }
                        });
                        const generateUniqueFishSkin = () => {
                            const size = 128;
                            const canvas = document.createElement('canvas');
                            canvas.width = size;
                            canvas.height = size;
                            const ctx = canvas.getContext('2d');
                            if (ctx) {
                                let hue = Math.floor(Math.random() * 360);
                                let valid = false;
                                let attempts = 0;
                                while (!valid && attempts < 50) {
                                    hue = Math.floor(Math.random() * 360);
                                    valid = true;
                                    for (let pastHue of recentHuesRef.current) {
                                        let diff = Math.abs(hue - pastHue);
                                        if (diff > 180) diff = 360 - diff;
                                        if (diff < 25) { valid = false; break; }
                                    }
                                    attempts++;
                                }
                                const newHistory = [hue, ...recentHuesRef.current].slice(0, 10);
                                recentHuesRef.current = newHistory;
                                const dir = Math.floor(Math.random() * 3);
                                let grd;
                                if (dir === 0) grd = ctx.createLinearGradient(0, 0, size, 0);
                                else if (dir === 1) grd = ctx.createLinearGradient(0, 0, 0, size);
                                else grd = ctx.createLinearGradient(0, 0, size, size);
                                const hue2 = (hue + 30 + Math.floor(Math.random() * 30)) % 360;
                                const s = 80 + Math.random() * 20;
                                const l = 45 + Math.random() * 15;
                                grd.addColorStop(0, `hsl(${hue}, ${s}%, ${l}%)`);
                                grd.addColorStop(1, `hsl(${hue2}, ${s}%, ${l - 10}%)`);
                                ctx.fillStyle = grd;
                                ctx.fillRect(0, 0, size, size);
                            }
                            return new THREE.CanvasTexture(canvas);
                        };
                        const gradientTexture = generateUniqueFishSkin();
                        const body = activeFish.getObjectByName("fish_body");
                        if (body) {
                            body.material.map = gradientTexture;
                            body.material.color.setHex(0xffffff);
                            body.material.needsUpdate = true;
                        }
                    }
                }
            }, [hasStarted, activeStudentId, updateStudentHistory]);

            useEffect(() => { triggerGameActionRef.current = triggerGameAction; }, [triggerGameAction]);
            const playSound = async (type) => {
                if (!audioEnabledRef.current && type !== 'click' && type !== 'wii_click') return;
                try {
                    await audioSynth.init();
                    switch (type) {
                        case 'cast': audioSynth.playCast(); break;
                        case 'splash': audioSynth.playSplash(1.0); break;
                        case 'splash_soft': audioSynth.playSplash(0.2); break;
                        case 'splash_heavy': audioSynth.playSplash(3.0); break;
                        case 'lens_hit': audioSynth.playLensHit(); break;
                        case 'ocean': audioSynth.startOcean(); break;
                        case 'reel': audioSynth.playReel(); break;
                        case 'win': audioSynth.playWin(); break;
                        case 'click': audioSynth.playClick(); break;
                        case 'wii_click': audioSynth.playWiiClick(); break;
                        case 'bite': audioSynth.startBite(); break;
                    }
                } catch (e) { console.warn("Audio synth error", e); }
            };
            const stopBiteSound = () => { audioSynth.stopBite(); };
            const createRipple = (position) => {
                if (!sceneRef.current) return;
                const geometry = new THREE.RingGeometry(0.5, 1.5, 32);
                const material = new THREE.MeshBasicMaterial({ color: 0xffffff, transparent: true, opacity: 0.8, side: THREE.DoubleSide });
                const ripple = new THREE.Mesh(geometry, material);
                ripple.rotation.x = -Math.PI / 2;
                ripple.position.copy(position);
                ripple.position.y = 0.5;
                sceneRef.current.add(ripple);
                ripplesRef.current.push(ripple);
            };
            const createSplash = (position, count = 15, scale = 1.0, withRipple = true) => {
                if (!sceneRef.current) return;
                if (withRipple) createRipple(position);
                const geo = new THREE.SphereGeometry(0.3 * scale, 4, 4);
                const mat = new THREE.MeshBasicMaterial({ color: 0xccffff });
                for (let i = 0; i < count; i++) {
                    const mesh = new THREE.Mesh(geo, mat);
                    mesh.position.copy(position);
                    mesh.position.x += (Math.random() - 0.5) * 2;
                    mesh.position.z += (Math.random() - 0.5) * 2;
                    sceneRef.current.add(mesh);
                    const velocity = new THREE.Vector3(
                        (Math.random() - 0.5) * 20 * scale,
                        (Math.random() * 20 + 10) * scale,
                        (Math.random() - 0.5) * 20 * scale
                    );
                    splashParticlesRef.current.push({ mesh, velocity, life: 1.0 });
                }
            };
            const createRodModel = () => {
                const pivotGroup = new THREE.Group();
                const rodGroup = new THREE.Group();
                pivotGroup.add(rodGroup);
                const handle = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.8, 1.0, 15, 16),
                    new THREE.MeshStandardMaterial({ color: 0x8b5a2b, roughness: 0.8 })
                );
                handle.rotation.x = Math.PI / 2;
                handle.position.z = -7;
                rodGroup.add(handle);
                const shaft = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.2, 0.7, 60, 16),
                    new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.2, metalness: 0.5 })
                );
                shaft.rotation.x = Math.PI / 2;
                shaft.position.z = 30;
                rodGroup.add(shaft);
                const ringPositions = [10, 25, 40, 55];
                ringPositions.forEach((z, i) => {
                    const scale = 1 - (i * 0.2);
                    const ring = new THREE.Mesh(
                        new THREE.TorusGeometry(0.6 * scale, 0.08, 8, 16),
                        new THREE.MeshStandardMaterial({ color: 0xcccccc, metalness: 0.8 })
                    );
                    ring.position.set(0, 0.6, z);
                    rodGroup.add(ring);
                });
                const tip = new THREE.Object3D();
                tip.position.set(0, 0, 60);
                rodGroup.add(tip);
                const reelGroup = new THREE.Group();
                reelGroup.position.set(0, -1.8, 1);
                const reelBody = new THREE.Mesh(
                    new THREE.CylinderGeometry(1.5, 1.5, 3, 32),
                    new THREE.MeshStandardMaterial({ color: 0x333333, metalness: 0.8, roughness: 0.2 })
                );
                reelBody.rotation.z = Math.PI / 2;
                reelGroup.add(reelBody);
                rodGroup.add(reelGroup);
                return { pivot: pivotGroup, mesh: rodGroup, tip };
            };
            const createArrowModel = () => {
                const group = new THREE.Group();
                const mat = new THREE.MeshStandardMaterial({
                    color: 0xFF2400, emissive: 0xFF1100, emissiveIntensity: 0.6, roughness: 0.2, metalness: 0.1
                });
                const head = new THREE.Mesh(new THREE.ConeGeometry(5, 12, 4), mat);
                head.rotation.x = Math.PI;
                head.rotation.y = Math.PI / 4;
                head.position.y = 6;
                head.layers.set(1);
                group.add(head);
                const shaft = new THREE.Mesh(new THREE.BoxGeometry(2.5, 12, 2.5), mat);
                shaft.position.y = 18;
                shaft.layers.set(1);
                group.add(shaft);
                return group;
            };
            const createFishVariant = (geometry, sx, sy, sz) => {
                const group = new THREE.Group();
                const bodyMat = new THREE.MeshPhysicalMaterial({
                    color: 0xff8c00, roughness: 0.25, metalness: 0.1, clearcoat: 1.0, clearcoatRoughness: 0.15, reflectivity: 0.8
                });
                const fishBody = new THREE.Mesh(geometry, bodyMat);
                fishBody.name = "fish_body";
                fishBody.scale.set(sx, sy, sz);
                group.add(fishBody);
                const eyeWhiteMat = new THREE.MeshBasicMaterial({ color: 0xffffff });
                const eyePupilMat = new THREE.MeshBasicMaterial({ color: 0x000000 });
                const createEye = (origX, origY, origZ) => {
                    const eyeGroup = new THREE.Group();
                    const white = new THREE.Mesh(new THREE.SphereGeometry(0.35, 16, 16), eyeWhiteMat);
                    const pupil = new THREE.Mesh(new THREE.SphereGeometry(0.18), eyePupilMat);
                    pupil.position.z = 0.28;
                    white.add(pupil);
                    eyeGroup.add(white);
                    eyeGroup.position.set(origX * sx, origY * sy, origZ * sz);
                    return eyeGroup;
                };
                const eye1L = createEye(ORIG_EYE_L.x, ORIG_EYE_L.y, ORIG_EYE_L.z);
                eye1L.lookAt(new THREE.Vector3(1 * sx, 0.5 * sy, 2 * sz));
                eye1L.name = "eye_left";
                group.add(eye1L);
                const eye1R = createEye(ORIG_EYE_R.x, ORIG_EYE_R.y, ORIG_EYE_R.z);
                eye1R.lookAt(new THREE.Vector3(1 * sx, 0.5 * sy, -2 * sz));
                eye1R.name = "eye_right";
                group.add(eye1R);
                const labelGeo = new THREE.PlaneGeometry(3.5, 2.0);
                const labelMat = new THREE.MeshBasicMaterial({ transparent: true, side: THREE.DoubleSide });
                const labelRight = new THREE.Mesh(labelGeo, labelMat);
                labelRight.position.set(ORIG_LABEL_R.x * sx, ORIG_LABEL_R.y * sy, ORIG_LABEL_R.z * sz);
                labelRight.rotation.y = Math.PI;
                labelRight.name = "label_right";
                group.add(labelRight);
                return group;
            };

            useEffect(() => {
                if (!containerRef.current) return;
                try {
                    const scene = new THREE.Scene();
                    sceneRef.current = scene;
                    const camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 1, 20000);
                    camera.position.set(CAMERA_CONFIG.position.x, CAMERA_CONFIG.position.y, CAMERA_CONFIG.position.z);
                    camera.lookAt(CAMERA_CONFIG.lookAt.x, CAMERA_CONFIG.lookAt.y, CAMERA_CONFIG.lookAt.z);
                    camera.layers.enable(1);
                    cameraRef.current = camera;
                    const renderer = new THREE.WebGLRenderer({ 
                                     antialias: false, 
                                     alpha: true,
                                     powerPreference: "high-performance"
                    });
                    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1));
                    renderer.setSize(window.innerWidth, window.innerHeight);
                    renderer.toneMapping = THREE.ACESFilmicToneMapping;
                    renderer.toneMappingExposure = 0.5;
                    containerRef.current.appendChild(renderer.domElement);
                    rendererRef.current = renderer;
                    const sun = new THREE.Vector3();
                    const parameters = { elevation: SCENE_SETTINGS.sky.elevation, azimuth: SCENE_SETTINGS.sky.azimuth };
                    const phi = THREE.MathUtils.degToRad(90 - parameters.elevation);
                    const theta = THREE.MathUtils.degToRad(parameters.azimuth);
                    sun.setFromSphericalCoords(1, phi, theta);
                    const sky = new Sky();
                    sky.scale.setScalar(10000);
                    scene.add(sky);
                    const skyUniforms = sky.material.uniforms;
                    skyUniforms['turbidity'].value = SCENE_SETTINGS.sky.turbidity;
                    skyUniforms['rayleigh'].value = SCENE_SETTINGS.sky.rayleigh;
                    skyUniforms['mieCoefficient'].value = SCENE_SETTINGS.sky.mieCoefficient;
                    skyUniforms['mieDirectionalG'].value = SCENE_SETTINGS.sky.mieDirectionalG;
                    sky.material.uniforms['sunPosition'].value.copy(sun);
                    const waterGeometry = new THREE.PlaneGeometry(10000, 10000);
                    const water = new Water(
                        waterGeometry,
                        {
                            textureWidth: 128,
                            textureHeight: 128,
                            waterNormals: new THREE.TextureLoader().load(WATER_NORMALS_URL, (texture) => {
                                texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
                            }),
                            sunDirection: sun.clone().normalize(),
                            sunColor: SCENE_SETTINGS.sunColor,
                            waterColor: SCENE_SETTINGS.waterColor,
                            distortionScale: 3.7,
                            fog: scene.fog !== undefined
                        }
                    );
                    water.rotation.x = -Math.PI / 2;
                    scene.add(water);
                    waterRef.current = water;
                    const ambientLight = new THREE.HemisphereLight(SCENE_SETTINGS.ambientLightColor, 0x000000, SCENE_SETTINGS.ambientLightIntensity);
                    scene.add(ambientLight);
                    const dirLight = new THREE.DirectionalLight(0xffffff, SCENE_SETTINGS.dirLightIntensity);
                    dirLight.position.setFromSphericalCoords(100, phi, theta);
                    scene.add(dirLight);
                    const { pivot: rodPivot, mesh: rodMesh, tip: rodTip } = createRodModel();
                    rodPivot.position.set(ROD_CONFIG.position.x, ROD_CONFIG.position.y, ROD_CONFIG.position.z);
                    rodMesh.rotation.set(ROD_CONFIG.rotation.x, ROD_CONFIG.rotation.y, ROD_CONFIG.rotation.z);
                    scene.add(rodPivot);
                    rodPivotRef.current = rodPivot;
                    rodTipRef.current = rodTip;
                    dummyLookTarget.current.position.copy(rodPivot.position);
                    const bobberGroup = new THREE.Group();
                    const bobberTop = new THREE.Mesh(
                        new THREE.SphereGeometry(1.0, 32, 16, 0, Math.PI * 2, 0, Math.PI / 2),
                        new THREE.MeshStandardMaterial({ color: 0xff0000, roughness: 0.2, metalness: 0.1 })
                    );
                    const bobberBottom = new THREE.Mesh(
                        new THREE.SphereGeometry(1.0, 32, 16, 0, Math.PI * 2, Math.PI / 2, Math.PI / 2),
                        new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.2, metalness: 0.1 })
                    );
                    bobberGroup.add(bobberTop);
                    bobberGroup.add(bobberBottom);
                    bobberGroup.visible = false;
                    scene.add(bobberGroup);
                    bobberRef.current = bobberGroup;
                    const arrow = createArrowModel();
                    arrow.visible = false;
                    scene.add(arrow);
                    arrowRef.current = arrow;
                    const lineGeo = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(), new THREE.Vector3()]);
                    const lineMat = new THREE.LineBasicMaterial({ color: 0xffffff, opacity: 0.8, transparent: true, linewidth: 2 });
                    const line = new THREE.Line(lineGeo, lineMat);
                    line.visible = false;
                    scene.add(line);
                    lineRef.current = line;
                    const objGeometry = parseCustomOBJ(FISH_OBJ_DATA);
                    objGeometry.center();
                    objGeometry.rotateY(Math.PI / 2);
                    fishVariationsRef.current = [];
                    for (let i = 0; i < FISH_VARIATION_COUNT; i++) {
                        const sx = 1.2 + Math.random() * (2.8 - 1.2);
                        const sy = 1.5 + Math.random() * (3.0 - 1.5);
                        const sz = 2.5;
                        const fishGroup = createFishVariant(objGeometry, sx, sy, sz);
                        fishGroup.visible = false;
                        scene.add(fishGroup);
                        fishVariationsRef.current.push(fishGroup);
                    }
                } catch (err) { console.error("Critical error initializing Three.js scene:", err); }

                const animate = () => {
                    reqIdRef.current = requestAnimationFrame(animate);
                    if (!sceneRef.current || !cameraRef.current || !rendererRef.current) return;
                    const time = performance.now() * 0.001;
                    let shakeX = 0, shakeY = 0;
                    if (cameraShakeRef.current.intensity > 0) {
                        const shake = Math.random() * cameraShakeRef.current.intensity;
                        shakeX = (Math.random() - 0.5) * shake;
                        shakeY = (Math.random() - 0.5) * shake;
                        cameraShakeRef.current.intensity *= 0.9;
                        if (cameraShakeRef.current.intensity < 0.1) cameraShakeRef.current.intensity = 0;
                    }
                    cameraRef.current.position.x = CAMERA_CONFIG.position.x + shakeX;
                    cameraRef.current.position.y = CAMERA_CONFIG.position.y + shakeY;
                    if (activeControlRef.current && (remoteMoveDirRef.current.x !== 0 || remoteMoveDirRef.current.y !== 0)) {
                        const speed = 0.02;
                        let newX = mouseRef.current.x + remoteMoveDirRef.current.x * speed;
                        let newY = mouseRef.current.y + remoteMoveDirRef.current.y * speed;
                        newX = Math.max(-1, Math.min(1, newX));
                        newY = Math.max(-1, Math.min(1, newY));
                        mouseRef.current.set(newX, newY);
                    }
                    if (waterRef.current && waterRef.current.material) waterRef.current.material.uniforms['time'].value += 1.0 / 60.0;
                    if (Math.random() < 0.05) {
                        const bubbleGeo = new THREE.SphereGeometry(0.3 + Math.random() * 0.5, 8, 8);
                        const bubbleMat = new THREE.MeshBasicMaterial({ color: 0x88ccff, transparent: true, opacity: 0.6 });
                        const bubble = new THREE.Mesh(bubbleGeo, bubbleMat);
                        bubble.position.set((Math.random() - 0.5) * 120, 0, (Math.random() - 0.5) * 80);
                        sceneRef.current.add(bubble);
                        bubblesRef.current.push(bubble);
                    }
                    for (let i = bubblesRef.current.length - 1; i >= 0; i--) {
                        const b = bubblesRef.current[i];
                        b.position.y += 0.1;
                        b.scale.multiplyScalar(0.98);
                        b.material.opacity -= 0.01;
                        if (b.position.y > 5 || b.material.opacity <= 0) {
                            sceneRef.current.remove(b);
                            bubblesRef.current.splice(i, 1);
                        }
                    }
                    for (let i = ripplesRef.current.length - 1; i >= 0; i--) {
                        const r = ripplesRef.current[i];
                        r.scale.multiplyScalar(1.05);
                        r.material.opacity -= 0.02;
                        if (r.material.opacity <= 0) {
                            sceneRef.current.remove(r);
                            ripplesRef.current.splice(i, 1);
                        }
                    }
                    for (let i = splashParticlesRef.current.length - 1; i >= 0; i--) {
                        const p = splashParticlesRef.current[i];
                        p.velocity.y -= 0.98;
                        p.mesh.position.add(p.velocity.clone().multiplyScalar(0.016));
                        p.life -= 0.02;
                        if (p.mesh.position.y < 0) p.life = 0;
                        if (p.life <= 0) {
                            sceneRef.current.remove(p.mesh);
                            splashParticlesRef.current.splice(i, 1);
                        }
                    }
                    if (rodPivotRef.current && stateRef.current === GameState.IDLE) {
                        raycasterRef.current.setFromCamera(mouseRef.current, cameraRef.current);
                        if (waterRef.current) {
                            const intersects = raycasterRef.current.intersectObject(waterRef.current);
                            if (intersects.length > 0) {
                                const targetPoint = intersects[0].point;
                                if (targetPoint.z > 80) {
                                    const dir = targetPoint.clone().sub(cameraRef.current.position);
                                    dir.y = 0;
                                    dir.normalize();
                                    const farPoint = cameraRef.current.position.clone().add(dir.multiplyScalar(GAME_CONFIG.maxCastDistance));
                                    farPoint.y = 0;
                                    dummyLookTarget.current.lookAt(farPoint);
                                } else {
                                    dummyLookTarget.current.lookAt(targetPoint);
                                }
                                rodPivotRef.current.quaternion.slerp(dummyLookTarget.current.quaternion, 0.1);
                            } else {
                                const dir = raycasterRef.current.ray.direction.clone();
                                dir.normalize();
                                const farPoint = cameraRef.current.position.clone().add(dir.multiplyScalar(GAME_CONFIG.maxCastDistance));
                                dummyLookTarget.current.lookAt(farPoint);
                                rodPivotRef.current.quaternion.slerp(dummyLookTarget.current.quaternion, 0.1);
                            }
                        }
                    }
                    const worldRodTip = new THREE.Vector3();
                    if (rodTipRef.current) rodTipRef.current.getWorldPosition(worldRodTip);
                    if (worldRodTip.y < 0 && !rodTipSubmergedRef.current) {
                        createSplash(new THREE.Vector3(worldRodTip.x, 0, worldRodTip.z), 12, 0.6, false);
                        playSound('splash_soft');
                        rodTipSubmergedRef.current = true;
                    } else if (worldRodTip.y > 0) { rodTipSubmergedRef.current = false; }
                    if (bobberRef.current) {
                        const bobber = bobberRef.current;
                        const currentState = stateRef.current;
                        if (arrowRef.current) {
                            if (currentState === GameState.BITING) {
                                arrowRef.current.visible = true;
                                const bobberPos = bobber.position;
                                arrowRef.current.position.set(bobberPos.x, bobberPos.y + 6, bobberPos.z);
                                arrowRef.current.position.y += Math.sin(time * 20) * 1.5;
                                arrowRef.current.rotation.z = Math.sin(time * 30) * 0.2;
                                arrowRef.current.rotation.x = Math.sin(time * 25) * 0.2;
                            } else { arrowRef.current.visible = false; }
                        }
                        if (currentState === GameState.CASTING) {
                            const elapsed = performance.now() - castStartTime.current;
                            const progress = Math.min(elapsed / castDuration, 1);
                            const endPos = targetPosition.current;
                            const currentPos = new THREE.Vector3().lerpVectors(worldRodTip, endPos, progress);
                            currentPos.y += Math.sin(progress * Math.PI) * 25;
                            bobber.position.copy(currentPos);
                            if (progress >= 1) {
                                stateRef.current = GameState.WAITING;
                                setGameState(GameState.WAITING);
                                playSound('splash');
                                createSplash(bobber.position, 10, 0.8, true);
                                const waitTime = GAME_CONFIG.minWaitTimeMs + Math.random() * (GAME_CONFIG.maxWaitTimeMs - GAME_CONFIG.minWaitTimeMs);
                                biteTimeRef.current = performance.now() + waitTime;
                            }
                        } else if (currentState === GameState.WAITING) {
                            bobber.position.y = targetPosition.current.y + Math.sin(time * 3) * 0.2;
                            if (performance.now() > biteTimeRef.current) {
                                stateRef.current = GameState.BITING;
                                setGameState(GameState.BITING);
                                playSound('splash');
                                playSound('bite');
                                biteTimeRef.current = performance.now() + GAME_CONFIG.biteWindowMs;
                            }
                        } else if (currentState === GameState.BITING) {
                            bobber.position.y = targetPosition.current.y + Math.sin(time * 50) * 1.5;
                            bobber.position.x += (Math.random() - 0.5) * 0.5;
                            bobber.position.z += (Math.random() - 0.5) * 0.5;
                            if (Math.random() < 0.15) {
                                const scale = 0.3 + Math.random() * 0.5;
                                const count = 3 + Math.floor(Math.random() * 5);
                                createSplash(bobber.position, count, scale, true);
                            }
                            if (performance.now() > biteTimeRef.current) {
                                stateRef.current = GameState.IDLE;
                                setGameState(GameState.IDLE);
                                bobber.visible = false;
                                if (lineRef.current) lineRef.current.visible = false;
                                stopBiteSound();
                            }
                        } else if (currentState === GameState.REELING) {
                            bobber.position.lerp(worldRodTip, 0.05);
                            bobber.position.y += 0.8;
                            const activeFish = fishVariationsRef.current[activeFishIndexRef.current];
                            if (activeFish) {
                                activeFish.position.copy(bobber.position);
                                activeFish.position.y -= 2;
                                activeFish.rotation.z = -Math.PI / 2 + Math.sin(time * 20) * 0.5;
                                activeFish.rotation.y += 0.2;
                                activeFish.scale.set(1, 1, 1);
                            }
                            if (bobber.position.distanceTo(worldRodTip) < 8 || bobber.position.y > 15) {
                                stateRef.current = GameState.REWARD;
                                setGameState(GameState.REWARD);
                                const surfacePos = new THREE.Vector3(bobber.position.x, 0, bobber.position.z);
                                createSplash(surfacePos, 60, 2.0, true);
                                playSound('splash_heavy');
                            }
                        } else if (currentState === GameState.REWARD) {
                            const activeFish = fishVariationsRef.current[activeFishIndexRef.current];
                            if (activeFish && cameraRef.current) {
                                const camDir = new THREE.Vector3();
                                cameraRef.current.getWorldDirection(camDir);
                                const targetPos = new THREE.Vector3().copy(cameraRef.current.position).add(camDir.multiplyScalar(25));
                                activeFish.position.lerp(targetPos, 0.3);
                                const dist = activeFish.position.distanceTo(targetPos);
                                if (dist < 4.0) {
                                    if (!hasPlayedLensSound.current) {
                                        hasPlayedLensSound.current = true;
                                        playSound('lens_hit');
                                        cameraShakeRef.current.intensity = 2.0;
                                        setShowScreenSplashes(true);
                                    }
                                }
                                if (dist < 1.0) {
                                    if (!hasPlayedWinSound.current) {
                                        hasPlayedWinSound.current = true;
                                        playSound('win');
                                        const duration = audioSynth.getWinDuration();
                                        setTimeout(() => { setShowRewardButton(true); }, duration * 0.5);
                                    }
                                }
                                activeFish.lookAt(cameraRef.current.position);
                                activeFish.rotation.z = 0;
                                activeFish.rotation.x = 0;
                                activeFish.rotation.y += Math.PI;
                                const breathe = 3.5 + Math.sin(time * 3) * 0.1;
                                activeFish.scale.set(breathe, breathe, breathe);
                            }
                            bobber.visible = false;
                            if (lineRef.current) lineRef.current.visible = false;
                            if (rodPivotRef.current) {
                                const targetQ = new THREE.Quaternion().setFromEuler(new THREE.Euler(-Math.PI / 1.1, 0, 0));
                                rodPivotRef.current.quaternion.slerp(targetQ, 0.04);
                                const targetPos = new THREE.Vector3(
                                    ROD_CONFIG.position.x + 10,
                                    ROD_CONFIG.position.y + 30,
                                    ROD_CONFIG.position.z + 100
                                );
                                rodPivotRef.current.position.lerp(targetPos, 0.04);
                            }
                        }
                        if (lineRef.current && lineRef.current.visible && currentState !== GameState.REWARD && currentState !== GameState.IDLE) {
                            const line = lineRef.current;
                            const positions = line.geometry.attributes.position.array;
                            positions[0] = worldRodTip.x;
                            positions[1] = worldRodTip.y;
                            positions[2] = worldRodTip.z;
                            positions[3] = bobber.position.x;
                            positions[4] = bobber.position.y;
                            positions[5] = bobber.position.z;
                            line.geometry.attributes.position.needsUpdate = true;
                        }
                    }
                    rendererRef.current.render(sceneRef.current, cameraRef.current);
                };
                animate();
                const onResize = () => {
                    if (cameraRef.current && rendererRef.current) {
                        cameraRef.current.aspect = window.innerWidth / window.innerHeight;
                        cameraRef.current.updateProjectionMatrix();
                        rendererRef.current.setSize(window.innerWidth, window.innerHeight);
                    }
                };
                const onPointerMove = (event) => {
                    if (activeControlRef.current) return;
                    let clientX, clientY;
                    if (event.touches) { clientX = event.touches[0].clientX; clientY = event.touches[0].clientY; }
                    else { clientX = event.clientX; clientY = event.clientY; }
                    mouseRef.current.x = (clientX / window.innerWidth) * 2 - 1;
                    mouseRef.current.y = -(clientY / window.innerHeight) * 2 + 1;
                };
                window.addEventListener('resize', onResize);
                window.addEventListener('mousemove', onPointerMove);
                window.addEventListener('touchmove', onPointerMove, { passive: false });
                return () => {
                    window.removeEventListener('resize', onResize);
                    window.removeEventListener('mousemove', onPointerMove);
                    window.removeEventListener('touchmove', onPointerMove);
                    if (reqIdRef.current) cancelAnimationFrame(reqIdRef.current);
                    if (rendererRef.current && rendererRef.current.domElement) rendererRef.current.domElement.remove();
                    if (rendererRef.current) rendererRef.current.dispose();
                };
            }, []);

            const handleStart = () => {
                setHasStarted(true);
                audioEnabledRef.current = true;
                audioSynth.init();
                playSound('ocean');
            };

            const handleReset = () => {
                const student = students.find(s => s.id === activeStudentId);
                const playedCount = student ? (student.history || []).length : 0;

                if (activeStudentId && playedCount >= maxPlays) {
                    if (wsRef.current) wsRef.current.send(JSON.stringify({ type: 'REVOKE_CONTROL' }));
                    setActiveStudentId(null);
                    activeControlRef.current = null;
                    stateRef.current = GameState.IDLE;
                    setGameState(GameState.IDLE);
                    setShowRewardButton(false);
                    setShowScreenSplashes(false);
                    hasPlayedWinSound.current = false;
                    hasPlayedLensSound.current = false;
                    fishVariationsRef.current.forEach(g => g.visible = false);
                    if (rodPivotRef.current) {
                        rodPivotRef.current.position.set(ROD_CONFIG.position.x, ROD_CONFIG.position.y, ROD_CONFIG.position.z);
                        rodPivotRef.current.rotation.set(ROD_CONFIG.rotation.x, ROD_CONFIG.rotation.y, ROD_CONFIG.rotation.z);
                    }
                    return;
                }

                stateRef.current = GameState.IDLE;
                setGameState(GameState.IDLE);
                setShowRewardButton(false);
                setShowScreenSplashes(false);
                hasPlayedWinSound.current = false;
                hasPlayedLensSound.current = false;
                fishVariationsRef.current.forEach(g => g.visible = false);

                if (rodPivotRef.current) {
                    rodPivotRef.current.position.set(ROD_CONFIG.position.x, ROD_CONFIG.position.y, ROD_CONFIG.position.z);
                    rodPivotRef.current.rotation.set(ROD_CONFIG.rotation.x, ROD_CONFIG.rotation.y, ROD_CONFIG.rotation.z);
                }

                if (activeStudentId && wsRef.current) {
                    wsRef.current.send(JSON.stringify({
                        type: 'GAME_STATE_UPDATE',
                        state: GameState.IDLE,
                        vibrate: false,
                        targetId: activeStudentId
                    }));
                }
            };

            const handleInteraction = () => {
                if (!activeControlRef.current) {
                    triggerGameAction();
                }
            };


            return (
                <div className="w-full h-full relative overflow-hidden cursor-crosshair touch-none">

                    <div
                        ref={containerRef}
                        className="w-full h-full"
                        onMouseDown={() => { if (!activeControlRef.current) handleInteraction(); }}
                        onTouchStart={(e) => { if (!activeControlRef.current) { e.preventDefault(); handleInteraction(); } }}
                    >
                        <UIOverlay
                            gameState={gameState}
                            onReset={handleReset}
                            hasStarted={hasStarted}
                            onStart={handleStart}
                            showRewardButton={showRewardButton}
                            showScreenSplashes={showScreenSplashes}
                        />
                    </div>


                    <button
                        onClick={(e) => {
                            e.stopPropagation();
                            setShowSidebar(!showSidebar);
                        }}
                        className="fixed top-7 -translate-y-1/2 right-0 z-[60] 
                       bg-blue-600 hover:bg-blue-500 
                       text-white p-3 rounded-l-lg 
                       shadow-[0_0_15px_rgba(0,0,0,0.4)] 
                       border-l-4 border-blue-300 
                       transition-all duration-200 
                       hover:pr-4 pr-2 group"
                        title="切換學生列表"
                    >
                        <span className="text-2xl leading-none group-hover:scale-110 transition-transform">🎏</span>
                    </button>


                    <div className={`fixed inset-y-0 right-0 w-80 transform transition-transform duration-300 ease-in-out z-50 ${showSidebar ? 'translate-x-0' : 'translate-x-full'
                        }`}>
                        <StudentPanel
                            students={students}
                            activeStudentId={activeStudentId}
                            onGrantControl={grantControl}
                            maxPlays={maxPlays}
                            setMaxPlays={setMaxPlays}
                            onShowLeaderboard={() => setShowLeaderboard(true)}
                            onRequestClose={() => setShowSidebar(false)}
                            onForceControl={forceResetGame}

                            onToggleQR={() => setShowQR(!showQR)}
                            isQRShown={showQR}
                        />
                    </div>

                    {showLeaderboard && (
                        <LeaderboardModal
                            students={students}
                            onClose={() => setShowLeaderboard(false)}
                        />
                    )}


                    {showQR && (
                        <div
                            className="fixed inset-0 z-[90] flex items-center justify-center bg-black/80 transition-opacity duration-300"
                            onClick={() => setShowQR(false)}
                        >
                            <div
                                className="bg-white p-8 rounded-3xl shadow-[0_0_50px_rgba(0,0,0,0.8)] flex flex-col items-center gap-6 relative animate-fade-in-up"
                                onClick={(e) => e.stopPropagation()}
                            >
                                <button
                                    onClick={() => setShowQR(false)}
                                    className="absolute -top-4 -right-4 bg-red-500 hover:bg-red-600 text-white w-10 h-10 rounded-full shadow-lg flex items-center justify-center text-xl font-bold transition-transform hover:scale-110"
                                >
                                    ✕
                                </button>

                                <h3 className="text-2xl font-black text-gray-800 tracking-wide">手機掃描連接釣魚控制器</h3>

                                <div className="p-4 bg-gray-100 rounded-xl border-4 border-gray-200">
                                    <img
                                        //這是QRCODE，把下面文字中的 https://scorefisher.onrender.com 換成自己控制器存放的網址。
                                        src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=https://pennyscorefisher.onrender.com"
                                        alt="Controller QR Code"
                                        className="w-64 h-64 md:w-80 md:h-80"
                                    />
                                </div>

                                <p className="text-gray-500 font-medium text-sm">
                                    掃描QRCODE
                                </p>
                            </div>
                        </div>
                    )}
                </div>
            );

        };

        const App = () => {
            return (
                <div className="w-screen h-screen bg-gray-900">
                    <FishingGame />
                </div>
            );
        };

        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(
            <React.StrictMode>
                <App />
            </React.StrictMode>
        );
    </script>
</body>

</html>